
%***************************************************************************
%
% CreditCruncher - A portfolio credit risk valorator
% Copyright (C) 2004 Gerard Torrent
%
% This program is free software; you can redistribute it and/or
% modify it under the terms of the GNU General Public License
% as published by the Free Software Foundation; either version 2
% of the License.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
%
%
% resolution.tex - TeX documentation file
% --------------------------------------------------------------------------
%
% 2005/01/22 - Gerard Torrent [gerard@fobos.generacio.com]
%   . initial release
%
%***************************************************************************

\chapter{Resoluci\'on}
\label{sec:resolution}

En este cap\'itulo se introducen los elementos usados para la resoluci\'on y
se describen dos m\'etodos de resoluci\'on basados en simulaci\'on:
Time-To-Default y Rating-Path.

%---------------------------------------------------------------------------

\section{Notaci\'on}

\begin{tabular}{|p{2.5cm}|p{9cm}|}
\hline
\textbf{Concepto} & \textbf{Descripci\'on} \\
\hline
\hline
$x_i$ & Componente $i$-esimo de $x$ \\
\hline
$x^i$ & Realizaci\'on $i$-esima de la variable aleatoria $X$ \\
\hline
\hline
$ns$ & N\'umero de sectores de la cartera \\
\hline
$nr$ & N\'umero de ratings del sistema de calificaci\'on \\
\hline
$nc$ & N\'umero de clientes de la cartera \\
\hline
$na_i$ &  N\'umero de activos del cliente $i$. $i \in \{1,\cdots,nc\}$\\
\hline
\hline
$s_i$ & Sector $i$-esimo. $i \in \{1,\cdots,ns\}$ \\
\hline
$r_i$ & Rating $i$-esimo. $i \in \{1,\cdots,nr\}$. $r_{nr}=Default$. \\
\hline
$c_i$ & Cliente $i$-esimo. $i \in \{1,\cdots,nc\}$ \\
\hline
\hline
$S_{t_0}$ & Curva spot de tipos de inter\'es en $t_0$. $S_{t_0}(t_k)$ es el
tipo de inter\'es de la curva en tiempo $t_k$ siendo $t_0 \leq t_k$\\
\hline
$\Upsilon(t_0,t_k, S_{t_0})$ & Funci\'on de transporte de $t_0$ a $t_k$ usando 
la curva spot $S_{t_0}$ \\
\hline
\hline
$Survival(r_i,t)$ & Funci\'on de supervivencia. Probabilidad que un cliente con 
rating inicial $r_i$ no haya hecho fallido en tiempo $t$\\
\hline
$M_T$ & Matriz de transici\'on a $T$ tiempo. Tiene dimensi\'on $nr \times nr$\\
\hline
$\Gamma$ & Matriz de correlaci\'on entre sectores. Dimensi\'on $ns \times ns$\\
\hline
$\Theta$ & Matriz de correlaci\'on entre clientes. Dimensi\'on $nc \times nc$\\
\hline
\hline
$X_{i,j}$ & Valor del $j$-esimo activo del cliente $i$.
$i \in \{1,\cdots,nc\}$, $j \in \{0,\cdots,na_i\}$ \\
\hline
$X_i$ & Valor de los activos del cliente $i$. $i \in \{1,\cdots,nc\}$ \\
\hline
$X$ & Valor de la cartera\\
\hline
$Z$ & P\'erdidas de la cartera\\
\hline
\end{tabular}

%---------------------------------------------------------------------------

\section{Variables aleatorias correlacionadas. C\'opulas.}

Se recomienda la lectura de las referencias \cite{copu:wang} y 
\cite{copu:pitfalls}. Se trata de art\'iculos donde se explica que es una 
c\'opula, sus propiedades, como simularlas, creencias err\'oneas, etc.

\paragraph{Definici\'on.} Llamamos \emph{c\'opula}\index{C\'opula} a la funci\'on
de distribuci\'on de una variable aleatoria $n$-dimensional tal que sus distribuciones
marginales \index{Distribuciones marginales} son variables aleatorias $U[0,1]$.
\begin{displaymath}
C(u_1, \cdots,u_n)=P(U_1 \leq u_1, \cdots, U_n \leq u_n) \qquad U_k \sim U[0,1]
\end{displaymath}

\begin{figure}[!hb]
\begin{minipage}[c]{0.5\columnwidth}%
  \centering
  \includegraphics[height=5cm, angle=0]{./images/copula.eps}
\end{minipage}%
\hfill{}
\begin{minipage}[c]{0.5\columnwidth}%
  \centering
  \includegraphics[height=5cm, angle=0]{./images/uniform.eps}
\end{minipage}%
\caption{Bivariate distribution plot with correlated and uncorrelated variables}
\label{copulas}
\end{figure}

\paragraph{Teorema.} \index{Teorema de Sklar} Toda variable aleatoria $n$-dimensional
puede separarse en las distribuciones seguidas por sus componentes (las distribuciones
marginales) y una c\'opula. Sea $F$ una funci\'on de distribuci\'on $n$-dimensional y
$f_1,\cdots, f_n$ sus marginales. El teorema de Sklar asegura que existe una 
c\'opula $C$ tq.
\begin{displaymath}
F(x_1, \cdots,x_n) = C(f_1(x_1), \cdots, f_n(x_n)) 
\end{displaymath}

\paragraph{Observaci\'on.} Una variable aleatoria $n$-dimensional no est\'a 
determinada por sus marginales y correlaciones entre estas. Dicho de otra
forma, existen infinitas formas de combinar las distribuciones marginales
 a trav\'es de c\'opulas de forma que cumplan las correlaciones. Las distribuciones 
el\'ipticas (que incluyen la distribuci\'on multinomial) son una excepci\'on. 

%---------------------------------------------------------------------------

\section{El m\'etodo de Monte Carlo}

Se recomienda la lectura de la referencia \cite{mc:mervyn}. Se trata de los 
apuntes para una clase del profesor Mervyn Marasinghe. Se expone el m\'etodo 
de Monte Carlo y las t\'ecnicas de reducci\'on de la varianza.

\paragraph{Definici\'on.} Dado un conjunto de observaciones, $x^1, \cdots, x^n$,
de la variable aleatoria $X$, definimos la \emph{funci\'on de distribuci\'on emp\'irica}
\index{Funci\'on de distribuci\'on emp\'irica} como:
\begin{displaymath}
\widetilde{F_X(k)} = \frac{1}{n} \sum_{i=1}^{n} I_{(-\infty,k]}(x^i) \qquad
I_{[-\infty,k]}(x) = \left\{
\begin{array}{ll}
1 & \textrm{ if } x \in (-\infty,k] \cr
0 & \textrm{ otherwise}
\end{array}
\right.
\end{displaymath}

\paragraph{Proposici\'on.} La funci\'on de distribuci\'on emp\'irica tiende a 
la funci\'on de distribuci\'on al incrementar el n\'umero de observaciones.
\begin{displaymath}
\qquad \lim_{n\to\infty} \widetilde{F_X} = F_X
\end{displaymath}

\paragraph{Definici\'on.} Sea $X$ una variable aleatoria con funci\'on de 
distribuci\'on conocida, $F$. El \emph{m\'etodo de Monte Carlo}\index{M\'etodo
de Monte Carlo} consiste en obtener la funci\'on de distribuci\'on emp\'irica 
de la variable aleatoria $H(X)$ usando el siguiente m\'etodo:
\begin{displaymath}
\begin{array}{ccc}
F_X                 &     \quad       & \widetilde{F_{H(X)}}    \cr
\downarrow          &     \quad       & \uparrow                \cr
\textrm{simulation} &     \quad       & \textrm{empirical } cdf \cr
\downarrow          &     \quad       & \uparrow                \cr
x^1,\cdots,x^n      & \longrightarrow & H(x^1),\cdots,H(x^n)
\end{array}
\end{displaymath}

\paragraph{Observaci\'on.} Problemas aparentemente no relacionados con las 
variables aleatorias pueden reformularse como un problema donde intervenga
una variable aleatoria y ser resueltos por el m\'etodo de Monte Carlo. 
Normalmente se formula el problema original como el c\'alculo de un 
estad\'istico (pe. la media) sobre la funci\'on de distribuci\'on. Al
m\'etodo de Monte Carlo se le atribuye una velocidad de convergencia  
del orden de $1/\sqrt{N}$.

\paragraph{Ejemplo:} El ejemplo cl\'asico es obtener el valor de la integral 
de la funci\'on $W$ entre $0$ y $1$. Lo reformulamos de la siguiente forma:
\begin{displaymath}
\int_{0}^{1} W(u) du = \int_{0}^{1} W(u) \phi(u) du = E[W(U)]
\end{displaymath}
donde $U \sim U[0,1]$ y $\phi(u) = \textrm{pdf}(U) = 1$. La \'ultima igualdad se
establece usando la preposici\'on enunciada en el ap\'endice \ref{apendix:stats}.
Finalmente la integral se aproxima calculando la media de un conjunto de puntos
con distribuci\'on $W(U)$.

%---------------------------------------------------------------------------

\section{Evaluaci\'on de la cartera}

\paragraph{Definici\'on.} Definimos el valor de un activo entre el tiempo
$t_0$ y $T$, habiendo hecho fallido en tiempo $w$ como:
\begin{equation}
\begin{array}{rl}
X_{i,j}(t_0,T,w) = & \textrm{1}_{[w \leq T]} \cdot \textrm{netting}(w) \cdot \Upsilon(w,T,S_{t_0}) + \cr
                   & \sum_{t_k=t_0}^{T} \textrm{1}_{[t_k < w]} \cdot \textrm{cashflow}(t_k) \cdot \Upsilon(t_k,T,S_{t_0})
\end{array}
\end{equation}

\paragraph{Definici\'on.} Definimos el valor de los activos del cliente $i$
entre el tiempo $t_0$ y $T$, habiendo hecho fallido en tiempo $w$ como:
\begin{equation}
X_i(t_0,T,w) = \sum_{j=0}^{na_i} X_{i,j}(t_0,T,w)
\end{equation}

\paragraph{Definici\'on.} Definimos el valor de la cartera entre el tiempo 
$t_0$ y $T$, siendo $\vec{w}$ los tiempos en los que han hecho fallido 
los clientes $\vec{c}$ como:
\begin{equation}
X(t_0,T,\vec{w}) = \sum_{i=0}^{nc} X_i(t) = \sum_{i=0}^{nc} \sum_{j=0}^{na_i} X_{i,j}(t_0,T,w_i)
\end{equation}

\paragraph{Definici\'on.} Definimos las p\'erdidas de la cartera entre el 
tiempo $t_0$ y $T$, siendo $\vec{w}$ los tiempos en los que han hecho fallido 
los clientes $\vec{c}$ como:
\begin{equation}
Z(t_0,T,\vec{w}) = X(t_0,T,T+1) - X(t_0,T,\vec{w})
\end{equation}

%---------------------------------------------------------------------------

\section{Simulaci\'on del tiempo de fallido}

El objetivo de este apartado es proporcionar m\'etodos para simular los
tiempos de fallido, $\vec{w} = \{w_1,w_2,w_3,\cdots,w_{NC}\}$ de los clientes
$\vec{c} = \{c_1,c_2,c_3,\cdots,c_{NC}\}$ cumpliendo:
\begin{itemize}
\item los fallidos de cada cliente deben satisfacer la matriz de transici\'on $M_T$
(o la funci\'on de supervivencia, $Survival(r,t)$).
\item la correlaci\'on entre los fallidos de los clientes debe cumplir la matriz
de correlaci\'on entre clientes, $\Theta$
\end{itemize}

\subsection{M\'etodo Rating-Path}

Para este m\'etodo es necesario disponer de la matriz de transici\'on, $M_T$.

\paragraph{Paso 1.} Segmentamos el tiempo en intervalos constantes de forma que
el intervalo de tiempo entre $t_i$ y $t_{i+1}$ es el cubierto por la matriz de
transici\'on, $T$.
\begin{displaymath}
t_0,t_1,t_2,\cdots,t_k, \cdots
\end{displaymath}

\paragraph{Paso 2.} Para cada intervalo de tiempo $k$ creamos una c\'opula,
$Qk$ de dimensi\'on $NC$ que satisfaga la matriz de correlaci\'on entre
clientes, $\Theta$.
\begin{displaymath}
Q1, Q2, Q3, \cdots, Qk, \cdots
\end{displaymath}

\paragraph{Paso 3.} Simulamos la c\'opula $Q1$. Simulemos el rating del cliente
$i$ en $t_1$. Disponemos del rating inicial $rating(t_0,i)$ y un valor $Q1_i \in [0,1]$
proporcionado por el componente $i$-\'esimo de $Q1$. Entonces
\begin{displaymath}
rating(t_1,i) = M_T^{-1}(rating(t_1,i),Q1_i)
\end{displaymath}
Este paso se encuentra ilustrado en la figura \ref{simrp}.

\paragraph{Paso 4.} Simulamos la c\'opula $Qk$. Simulemos el rating del cliente
$i$ en $t_k$. Disponemos del rating anterior $rating(t_{k-1},i)$ y un valor
$Qk_i \in [0,1]$ proporcionado por el componente $i$-\'esimo de $Qk$. Entonces
\begin{displaymath}
rating(t_k,i) = M_T^{-1}(rating(t_{k-1},i),Qk_i)
\end{displaymath}
Este paso se encuentra ilustrado en la figura \ref{simrp}. Finalmente, aproximamos
el tiempo de fallido del cliente $i$ de la siguiente forma:
\begin{displaymath}
w_i = inf\{t_k | rating(t_k,i) = default\}
\end{displaymath}

\begin{figure}[!hb]
\begin{center}
\includegraphics[width=7cm,angle=0]{./images/simrp.eps}
\caption{Simulaci\'on de la evoluci\'on del rating $BBB$ a $T$ tiempo}
\label{simrp}
\end{center}
\end{figure}

\subsection{M\'etodo Time-To-Default}

Para este m\'etodo es necesario disponer de la funci\'on de supervivencia. En caso
de disponer solamente de la matriz de transici\'on puede calcularse la funci\'on
de supervivencia asociada a la matriz de transici\'on.

\paragraph{Paso 1.} Creamos una c\'opula de dimensi\'on $NC$ que satisfaga la
matriz de correlaci\'on entre clientes, $\Theta$.
\begin{displaymath}
Q
\end{displaymath}

\paragraph{Paso 2.} Simulamos la c\'opula $Q$. Simulemos el tiempo de fallido del
cliente $i$, $w_i$. Disponemos del rating inicial, $rating(t_0,i)$ y un valor
$Q_i \in [0,1]$ proporcionado por el componente $i$-\'esimo de $Q$. Entonces:
\begin{displaymath}
w_i = Survival^{-1}(rating(t_0,i),Q_i)
\end{displaymath}
Este paso se encuentra ilustrado en la figura \ref{simttd}.

\begin{figure}[!hb]
\begin{center}
\includegraphics[width=10cm,angle=0]{./images/simttd.eps}
\caption{Simulaci\'on del tiempo hasta el fallido del rating $BBB$}
\label{simttd}
\end{center}
\end{figure}


%---------------------------------------------------------------------------

\section{Valoraci\'on del riesgo}

El m\'etodo de Monte Carlo genera $N$ realizaciones, $\{z_1,z_2,z_3,\cdots,z_N\}$,
de la variable aleatoria $Z$ (p\'erdidas de la cartera) que permiten obtener la
funci\'on de distribuci\'on emp\'irica. A continuaci\'on se exponen los estimadores
usados y el intervalo de confianza al nivel de confianza $\alpha$. CreditCruncher
utiliza el entorno \emph{R} \footnote{http://www.r-project.org} para realizar los
c\'alculos estad\'isticos. Para mas informaci\'on acerca de \emph{R} v\'ease \cite{stats:R}.
Sea $\phi^{-1}(x)$ la inversa de la funci\'on de distribuci\'on de la Normal(0,1).

\paragraph{Expected value.} F\'ormula extra\'ida de \cite{stats:schaum} basada en el
teorema del l\'imite central.
\begin{displaymath}
\mu_Z = \widehat{\mu_Z} \pm \phi^{-1}\left(\frac{1-\alpha}{2}\right) \cdot \frac{\widehat{\sigma_Z}}{\sqrt{N}}
\end{displaymath}
Consulte \ref{apendix:estim} para el c\'alculo de $\widehat{\mu_Z}$ y $\widehat{\sigma_Z}$.

\paragraph{Desviaci\'on est\'andar.} F\'ormula extra\'ida de \cite{stats:schaum} basada en el
teorema del l\'imite central.
\begin{displaymath}
\sigma_Z = \widehat{\sigma_Z} \pm \phi^{-1}\left(\frac{1-\alpha}{2}\right) \cdot \frac{\widehat{\sigma_Z}}{\sqrt{2N}}
\end{displaymath}
Consulte \ref{apendix:estim} para el c\'alculo de $\widehat{\sigma_Z}$.

\paragraph{Value at Risk.} Fijado un nivel de $VAR = x$
\begin{displaymath}
VAR_{x}(Z) = \widehat{q_{x}(Z)} \pm \phi^{-1}\left(\frac{1-\alpha}{2}\right) \cdot \textrm{stderr}(q_{x}(Z))
\end{displaymath}
Consulte \ref{apendix:estim} y \ref{apendix:stderrvar} para el c\'alculo de
$\widehat{q_{x}(Z)}$ y $\textrm{stderr}(q_{x}(Z))$.

\paragraph{TCE o Expected Shortfall.} Fijado un nivel de $VAR = x$
\begin{displaymath}
TCE_{x}(Z) = \widehat{TCE_{x}(Z)} \pm \phi^{-1}\left(\frac{1-\alpha}{2}\right) \cdot \textrm{stderr}(TCE_{x}(Z))
\end{displaymath}
Consulte \ref{apendix:estim} y \ref{apendix:stderrtce} para el c\'alculo de
$\widehat{TCE_{x}(Z)}$ y $\textrm{stderr}(TCE_{x}(Z))$.