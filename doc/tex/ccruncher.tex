%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% The Legrand Orange Book
% LaTeX Template
% Version 1.1 (11/4/13)
%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original author:
% Mathias Legrand (legrand.mathias@gmail.com)
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
%
% Compiling this template:
% This template uses biber for its bibliography and makeindex for its index.
% This means that to update the bibliography and index in this template you
% will need to run the following sequence of commands in the template
% directory:
%
% 1) pdflatex main
% 2) makeindex main.idx -s StyleInd.ist
% 3) biber main
% 4) pdflatex main
%
% This template also uses a number of packages which may need to be
% updated to the newest versions for the template to compile. It is strongly
% recommended you update your LaTeX distribution if you have any
% compilation errors.
%
% Important note:
% Chapter heading images should have a 2:1 width:height ratio,
% e.g. 920px width and 460px height.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[11pt,fleqn]{book} % Default font size and left-justified equations

\usepackage[top=3cm,bottom=3cm,left=3.2cm,right=3.2cm,headsep=10pt,a4paper]{geometry} % Page margins

\usepackage{xcolor} % Required for specifying colors by name
\definecolor{ocre}{RGB}{243,102,25} % Define the orange color used for highlighting throughout the book

% Font Settings
\usepackage{avant} % Use the Avantgarde font for headings
%\usepackage{times} % Use the Times font for headings
\usepackage{mathptmx} % Use the Adobe Times Roman as the default text font together with math symbols from the Sym­bol, Chancery and Com­puter Modern fonts
\usepackage{microtype} % Slightly tweak font spacing for aesthetics
\usepackage[utf8]{inputenc} % Required for including letters with accents
\usepackage[T1]{fontenc} % Use 8-bit encoding that has 256 glyphs

% Bibliography
\usepackage{hyperref} %added by GTG
\usepackage{csquotes} %added by GTG
\usepackage[sorting=nyt,sortcites=true,autopunct=true,babel=hyphen,hyperref=true,abbreviate=false,backend=biber]{biblatex} %style=alphabetic,backref=true,
\addbibresource{bibliography.bib} % BibTeX bibliography file
\defbibheading{bibempty}{}

% Index
\usepackage{calc} % For simpler calculation - used for spacing the index letter headings correctly
\usepackage{makeidx} % Required to make an index
\makeindex % Tells LaTeX to create the files required for indexing

% added by GTG
\usepackage{verbatim}
\usepackage{parskip}
\usepackage{enumitem}
\usepackage{changepage}
\usepackage[official]{eurosym}
\usepackage[lofdepth,lotdepth]{subfig}
\usepackage{nameref}
\usepackage{wrapfig}
\def\numversion{2.3}
\def\svnversion{R1024}

%----------------------------------------------------------------------------------------

\input{structure} % Insert the commands.tex file which contains the majority of the structure behind the template

\begin{document}

%==============================================================================
% TITLE PAGE
%==============================================================================
\begingroup
\thispagestyle{empty}
\AddToShipoutPicture*{\put(6,5){\includegraphics[scale=1]{background}}} % Image background
\vspace*{-1cm}
\centerline{\includegraphics[angle=0]{./Pictures/logo.png}}
\centering
\vspace*{1cm}
\par\normalfont\fontsize{35}{35}\sffamily\selectfont
Credit Risk Modeling \par % Book title
\par\normalfont\fontsize{25}{25}\sffamily\selectfont
Using CCruncher\par
\vspace*{2cm}
{\Huge Gerard Torrent}\par % Author name
\vspace*{5cm}
\par\normalfont\fontsize{14}{14}\sffamily\selectfont
Version \numversion\ [\svnversion]\par
\endgroup


%==============================================================================
% COPYRIGHT PAGE
%==============================================================================
\newpage
~\vfill
\thispagestyle{empty}
\noindent Version \numversion\ [\svnversion]\\ 
\\
\noindent Copyright \copyright\ 2013 Gerard Torrent\\ % Copyright notice
\\
\noindent 
This work is licensed to the public under Creative Commons 
Attribution-ShareAlike 3.0 Unported License. To view a copy 
of this license visit 
\url{http://creativecommons.org/licenses/by-sa/3.0/}.
We have invested a lot of time and effort in creating CCruncher, 
please cite it when using it for credit risk analysis.
\index{license}

% To cite CCruncher in publications use:
% \begin{adjustwidth}{2.5em}{0pt}
  % Gerard Torrent (2013). Credit risk modeling using CCruncher.
  % Tatine, Barcelona, Spain. URL http://www.ccruncher.net/.
% \end{adjustwidth}

% A BibTeX entry for LaTeX users is
% \begin{adjustwidth}{2.5em}{0pt}
% \begin{verbatim}
% @manual{ccruncher,
    % title = {{Credit risk modeling using CCruncher}},
    % author = {Torrent, Gerard},
    % organization = {Tatine},
    % address = {Barcelona, Spain},
    % year = {2013},
    % url = {http://www.ccruncher.net/},
% }
% \end{verbatim}
% \end{adjustwidth}

%TODO: set Acknowledgements paragraph (mother+Marga+Fortiana+Stijn)

%==============================================================================
% TABLE OF CONTENTS
%==============================================================================
\chapterimage{chapter_head_1.pdf} % Table of contents heading image
\pagestyle{empty} % No headers
\tableofcontents % Print the table of contents itself
\cleardoublepage % Forces the first chapter to start on an odd page so it's on the right
\pagestyle{fancy} % Print headers again


%==============================================================================
% INTRODUCTION
%==============================================================================
\chapter{Introduction}

CCruncher\index{CCruncher} is a computer software to calculate the credit 
risk of a portfolio. This document details the concepts, model and algorithms 
used in it. CCruncher is developed and mantained by 
\href{http://www.tatine.es}{Tatine}\index{Tatine}, a quantitative consulting 
firm located at Barcelona\index{Barcelona} (Spain). As much computer 
software as documentation are licensed with open-source\index{open-source} 
type licenses\index{license}. Take advantage of them but always remember to 
mention the source. You can download the latest version of this document and 
the computer software from the CCruncher's site, \url{http://www.ccruncher.net}.

Portfolio credit risk try to respond to questions like: what is my 
expected loss for the next year?, how much could I lose in a really 
bad year?. There are several approaches to answer these questions. 
All of them try to do the same: obtain the portfolio loss distribution
and measure the credit risk using a set of selected statistics (eg. mean, 
quantile). They differ on how to obtain this distribution. Here we present 
briefly the two most used approaches \cite{crouhy:2000} 
\cite[chap. 2.4]{bluhm:2002}.

\textbf{Actuarial approach}. This approach considere that the distribution of 
the number of defaults is the proper way to interpret the observed defaults.
Compounding defaults frequency with the obligors exposures gives the portfolio 
loss distribution that can be approximated by Panjer\index{Panjer} recursion, 
or by the FFT method. The main representative of this approach is the 
CreditRisk+\index{CreditRisk+} model \cite{creditrisk+:1997}.

\textbf{Merton based approach}. This approach considere that the obligors 
probabilities of default are the proper way to explain the observed defaults.
The sum of the obligors exposures weighted by the probability of default 
gives the portfolio loss distribution. This distribution is approximated 
using the Monte Carlo method. The main representative of this approach is the 
CreditMetrics\texttrademark\index{CreditMetrics\texttrademark} \cite{cmetrics:1997} 
model. Other representatives are the KMV\index{KMV} model, or the copula 
approach \index{copula approach} \cite{li:2000}.

Both approaches gives similar results \cite{koyluoglu:1998}.  
There are other approaches (eg. econometric) not mentioned here due to 
their minority status. By far, the most prolific approach is the Merton
model. CCruncher implements the copula approach, a Merton model version.

\textbf{Copula approach}. This approach considere that the obligors default 
times are the proper way to explain the observed defaults. The dependence 
between these default times is modeled using a copula. The sum of the 
obligors exposures at the default times gives the portfolio loss distribution.
David X. Li introduced this approach in the famous document
\emph{On Default Correlation: A Copula Function Approach} \cite{li:2000}
which stated that the CreditMetrics\texttrademark model can be interpreted 
in the copula approach context and that has a Gaussian copula.

%------------------------------------------------------------------------------
% CREDIT RISK MEASURES
%------------------------------------------------------------------------------
\section{Credit Risk Measures}

The portfolio credit risk is measured considering some statistics on 
the portfolio loss distribution. Let's start by defining what we mean 
by portfolio loss and then we define the most used measures. Figure 
\ref{fig:lossdistr} ilustrates the concepts exposed in this section.

\begin{definition}[Portfolio Loss at time $T$]
	The Portfolio Loss at time $T$ is the cumulated losses in the time 
	range $[0,T]$ caused by obligors that defaults (fails to make 
	payments which they are obligated to do).
	\begin{displaymath}
		L_T = \left\{
		\begin{array}{c}
			\text{sum of portfolio losses in time range $[0,T]$}
		\end{array}
		\right\}
	\end{displaymath}
\end{definition}

\begin{figure}[ht]
	\centering
	\includegraphics[width=12cm]{creditvar}
	\caption{Portfolio Loss Distribution at time $T$}
	\label{fig:lossdistr}
\end{figure}

\begin{definition}[Expected Loss (EL)]
	The Expected Loss of a portfolio at time horizon $T$ is the 
	mean of the portfolio loss distribution.
	\begin{displaymath}
		\text{EL}(L_T) = E(L_T)
	\end{displaymath}
\end{definition}

The Expected Loss responds to the question 'what is my expected loss for 
the next year?'. The Value At Risk \cite{var:jorion} is the most commonly 
used risk measure to respond the question 'how much could I lose in a really 
bad year?'.

\begin{definition}[Value At Risk (VAR)]
	The Value At Risk of a portfolio at time horizon $T$ and 
	confidence level $\alpha$ is the $\alpha$-quantile of the portfolio loss 
	distribution.
	\begin{displaymath}
		\text{VAR}_\alpha(L_T) = \inf\{x \in \mathbb{R} \mid F(x) \ge \alpha \}
	\end{displaymath}
	where $F(x)=\Pr\{L_T \le x\}$ is the portfolio loss distribution at time $T$.
\end{definition}

VAR is not a distance because it does not fulfil the sub-additive property 
\cite{var:varbad}, $\text{VAR}(A+B) \nleq \text{VAR}(A)+\text{VAR}(B)$. 
Similar to VAR, Expected Shortfall is a consistent risk measure 
\cite{var:eshortfall}.

\begin{definition}[Expected Shortfall (ES)]
	The Expected Shortfall of a portfolio at time horizon $T$ and 
	confidence level $\alpha$ is the average of the worst $\alpha\%$ losses.
	\begin{displaymath}
		\text{ES}_\alpha(L_T) = \text{E}(L_t \mid L_T \ge \text{VAR}_\alpha(L_T))
	\end{displaymath}
\end{definition}

%------------------------------------------------------------------------------
% BASIC CONCEPTS
%------------------------------------------------------------------------------
\section{Basic Concepts}
\label{basic_concepts}

Here we define the key concepts used to model the credit risk.
They are those of the Basel II accords \cite{basel2:2006}, the 
de-facto international financial risk regulation framework. These
directives are strongly influenced by the Merton based approach.
We emphasize the temporal dimension because it is a key point in 
further development. From now establish that the time unit is the 
year in order to simplify the exposition without loss of generality
(in fact, the time unit used internally by CCruncher is the day).

\begin{definition}[Probability of Default (PD)]
	The Probability of Default of the i-th obligor, $\text{PD}_i(t)$
	indicates the probability that this obligor defaults in the time 
	interval $(0,t]$.
	\begin{displaymath}
		\text{PD}_i(t) = \Pr\{T_i \le t\} = 
		\Pr\{\text{i-th obligor defaults before $t$ years}\}
	\end{displaymath}
	where $T_i$ is a random variable that represents the default
	time of the i-th obligor. Note that the PD defined in this way 
	is the cdf of $T_i$. We indicate as $p_i$ the probability that 
	i-the obligor defaults in the time range $[0,1]$.
	\begin{displaymath}
		p_i = \Pr\{T_i \le 1\} = \text{PD}_i(1) 
	\end{displaymath}
	Some texts use the concept of survival instead of the PD. The 
	survival is defines as:
	\begin{displaymath}
		\text{Survival}_i(t) = 1-\text{PD}_i(t)
	\end{displaymath}
\end{definition}

\begin{definition}[Exposure At Default (EAD)]
	The Exposure At Default of the j-th asset at time $t$ indicates 
	the total amount that bank is exposed if the obligor defaults:
	\begin{displaymath}
		\text{EAD}_j(t) = \left\{
		\begin{array}{c}
			\text{amount in risk of the j-th asset if the obligor} \\
			\text{defaults at time $t$, measured in currency}
		\end{array}
		\right\}
	\end{displaymath}
	EAD can be a function dependent of time when these amounts are
	fixed and know in advance (eg. loan), or can be a distribution
	defined over time when we have a model that support it 
	(eg. line of credit).
\end{definition}

\begin{definition}[Loss Given Default (LGD)]
	The Loss Given Default of the j-th asset at time $t$ indicates 
	the percentage of efective loss over the total exposure. This
	value depends on endorsements, guarantees, type of asset, 
	default time, etc.
	\begin{displaymath}
		\text{LGD}_j(t) = \left\{
		\begin{array}{c}
			\text{percentage of the $\text{EAD}_j(t)$ that is definitively} \\
			\text{lost if the obligor defaults at time $t$}
		\end{array}
		\right\}
	\end{displaymath}
	LGD can be a function dependent of time, or can be a distribution
	defined over time when we have a model that support it. 
	Some texts use the concept of recovery instead of LGD. This is 
	defined as:
	\begin{displaymath}
		\text{Recovery}_j(t) = 1- \text{LGD}_j(t)
	\end{displaymath}
\end{definition}

\begin{example}[Bond]
Let a 10-years fixed rate bond with an annual coupon of the
$4\%$ issued by a company rated BB. The credit rating agency 
reports, for this obligor and rating, the PD over time displayed 
in figure \ref{figure:bond} with a $\text{PD}(1)=1.06\%$. 
The EAD for this asset can be obtained from its expected cashflows 
because they are known in advance. We supose that the bank 
internal models indicate that in this case the LGD is a 
$\text{Beta}(5,2)$ distribution regardless of the default time.
Figure \ref{figure:bond} ilustrates the defined basic concepts 
applied to this bond.
\begin{figure}[h!]
\centering
\subfloat[Probability of Default]{
    \includegraphics[width=7cm]{bond_pd1}
}
\subfloat[Probability of Default (zoom)]{
    \includegraphics[width=7cm]{bond_pd2}
}
\\
\subfloat[Exposure At Default]{
    \includegraphics[width=7cm]{bond_ead}
}
\subfloat[Loss Given Default]{
    \includegraphics[width=7cm]{bond_lgd}
}
\caption{Basic concepts bond example}
\label{figure:bond} 
\end{figure}
\end{example}

%------------------------------------------------------------------------------
% CONTENT ORGANIZATION
%------------------------------------------------------------------------------
\section{Content Organization}

\cite{mcneil:2005}, \cite{sklar:1959}, \cite{li:2000}, 
\cite{roncalli:2001}, \cite{embrechts:2002}, \cite{cmetrics:1997},
\cite{ntzoufras:2009}, \cite{gordy:2002}, \cite{nagpal:2001},
\cite{meissner:2006}, \cite{bis:2006}, \cite{bluhm:2002},
\cite{frey:2001}, \cite{gossl:2005}, \cite{tarashev:2010},
\cite{creditrisk+:1997}, \cite{crouhy:2000}, \cite{koyluoglu:1998},
\cite{var:varbad}, \cite{var:eshortfall}, \cite{var:jorion},
\cite{basel2:2006}, \cite{kotz:2004}, \cite{garthwaite:2010},
\cite{long:2012}, \cite{kreinin:2001}, \cite{roncalli:2004},
\cite{anderson:1984}, \cite{yi:2006}, \cite{kenney:1951}


%==============================================================================
% MODELING DEFAULT TIMES
%==============================================================================
\chapter{Modeling Default Times}

The model described in this section is the same as described in \cite{li:2000} 
\cite{roncalli:2001} \cite{bluhm:2002} \cite{frey:2001}.
We recommend taking a look at the appendices 
\emph{\ref{ap:copula_basics}-\nameref{ap:copula_basics}},
\emph{\ref{ap:mtsd}-\nameref{ap:mtsd}},
\emph{\ref{ap:cbm}-\nameref{ap:cbm}},
\emph{\ref{ap:mfgm}-\nameref{ap:mfgm}}.
These contain definitions, results and details about subjects used 
in this section.

%------------------------------------------------------------------------------
% THE MULTIVARIATE MODEL
%------------------------------------------------------------------------------
\section{The Multivariate Model}

The copula approach considere that the obligors default times are the 
proper way to explain the observed defaults. This default times 
$(T_1, \dots, T_n)$ are modeled by a multivariate distribution $F$ 
such that:
\begin{displaymath}
	F(t_1, \dots, t_n) = \Pr \{T_1 \le t_1, \dots, T_n \le t_n\}
\end{displaymath}
where $n$ is the number of obligors in the portfolio, $T_i$ is the time 
(in years) when the i-th obligor defaults, and $F$ is the multivariate
default times distribution. Applying the Sklar's theorem to the above 
distribution we obtain:
\begin{displaymath}
	F(t_1, \dots, t_n) = 
	C\left(\text{PD}_1(t_1), \dots, \text{PD}_n(t_n)\right)
\end{displaymath}
where marginals $\text{PD}_i(t) = \Pr\{T_i \le t\}$ are the Probability 
of Default of the i-th obligor defined in section \ref{basic_concepts}, 
and $C$ is a copula. There are several proposals on the copula to be 
used. CCruncher considere that it is a t-Student copula for the following 
reasons:

%TODO: refs pending
\begin{itemize}
	\item is determined by the correlation matrix (elliptical). 
	\item is symmetrical (elliptical), allowing to 
	apply the antithetic reduction variance technique in the Monte Carlo 
	simulation.
	\item allows a wide range of dependence structures through parameter $\nu$.
	\item it exhibits tail dependence when $\nu \ne \infty$.
	\item exist an efficient simulation algorithm.
	\item the Gaussiana case ($\nu = \infty$) is the copula used by 
	CreditMetrics\texttrademark.
	\item it can be expressed as a multi-factor model.
\end{itemize}

Working directly the t-Student copula is cumbersome, therefore we 
reformulate $F$ in terms of the multivariate t-Student distribution 
applying the following proposition.

\begin{proposition}[Multivariate Default Times Distribution]
	\label{prop:dtd}
	Let $T=(T_1,\dots,T_n)$ the obligors default times with marginals 
	$\text{PD}_i$ and a t-Student copula $C_{\nu,\bar{R}}^n$ with $\nu$
	degrees of freedom and a $n {\times} n$ obligors correlation matrix 
	$\bar{R}$. Then, its distribution $F$ is:
	\begin{displaymath}
		F(t_1,\dots,t_n) = H\left(t_\nu^{-1}(\text{PD}_1(t_1)), \dots, t_\nu^{-1}(\text{PD}_n(t_n))\right)
	\end{displaymath}
	where $H$ is the cdf of the multivariate t-Student distribution 
	$t_n(\nu,0,\bar{R})$, and $t_\nu^{-1}$ is the inverse of the univariate 
	t-Student distribution $t_1(\nu,0,1)$.
\end{proposition}
\begin{proof}
	We note as $X=(X_1,\dots,X_n)$ a vector having a multivariate t-Student
	distribution $t_n(\nu,0,\bar{R})$, and $(U_1,\dots,U_n)$ to represent
	the components of the copula $C_{\nu,\bar{R}}^n$.
	\begin{displaymath}
		\begin{array}{rl}
			F(t_1,\dots,t_n) = & \Pr\{ T_1 \le t_1 , \dots, T_n \le t_n \} =                                    \\
			                   & \text{we use the corollary \ref{cor:cop3}: }                                   
			(T_1,\dots,T_n) = (\text{PD}_1^{-1}(U_1),\dots,\text{PD}_n^{-1}(U_n)) \\
			=                  & \Pr\{ \text{PD}_1^{-1}(U_1) \le t_1 , \dots , \text{PD}_n^{-1}(U_n) \le t_n \} =               \\
			                   & \text{we use the corollary \ref{cor:cop2}: }                                   
			(U_1,\dots,U_n) = (t_\nu(X_1),\dots,t_\nu(X_n)) \\
			=                  & \Pr\{ \text{PD}_1^{-1}(t_\nu(X_1)) \le t_1 , \dots , \text{PD}_n^{-1}(t_\nu(X_n)) \le t_n \} = \\
			=                  & \Pr\{ t_\nu(X_1) \le \text{PD}_1(t_1) , \dots , t_\nu(X_n) \le \text{PD}_n(t_n) \} =           \\
			=                  & \Pr\{ X_1 \le t_\nu^{-1}(\text{PD}_1(t_1)) , \dots , X_n \le t_\nu^{-1}(\text{PD}_n(t_n)) \} = \\
			=                  & H(t_\nu^{-1}(\text{PD}_1(t_1)), \dots, t_\nu^{-1}(\text{PD}_n(t_n)))                           \\
		\end{array}
	\end{displaymath}
\end{proof}

The previous proposition can be stated by any other copula coming from
a multivariate distribution an applied if this had an known distribution 
and marginals (eg. the Gaussian copula).

\subsection{The multi-factor formulation}

The current formulation is not yet satisfactory because the dimension 
$n {\times} n$ of the obligors correlation matrix causes that any 
operation (eg. simulate random value, or estimate the parameters) can 
not be done in practice when $n$ is large. To bypass this problem we
reduce the dimension of the problem assuming that exist a reduced number 
$k$ of industrial sectors and that each obligor belong to a unique sector. 
Also that default times dependence between obligors only depends on the 
involved industrials sectors. With these restrictions, if we sort the 
obligors by sector, the obligors default times correlation matrix, $\bar{R}$, 
is a $n {\times} n$ correlation block matrix $B_k(\vec{n},\vec{1},M)$. See 
appendix \ref{ap:cbm} for more information about covariance block matrices. 
\begin{displaymath}
	\bar{R} = B_k(\vec{n},\vec{1},M) = 
	\left(
	\begin{array}{ccccccc}
		1         & \dots  & \rho_{11} &        & \rho_{1k} & \dots  & \rho_{1k} \\
		\vdots    & \ddots & \vdots    & \dots  & \vdots    &        & \vdots    \\
		\rho_{11} & \dots  & 1         &        & \rho_{1k} & \dots  & \rho_{1k} \\
		
		          & \vdots &           & \ddots &           & \vdots &           \\
		
		\rho_{1k} & \dots  & \rho_{1k} &        & 1         & \dots  & \rho_{kk} \\
		\vdots    &        & \vdots    & \dots  & \vdots    & \ddots & \vdots    \\
		\rho_{1k} & \dots  & \rho_{1k} &        & \rho_{kk} & \dots  & 1         \\
	\end{array}
	\right)
	\qquad 
	\begin{array}{l}
		M = 
		\left(
		\begin{array}{ccc}
		\rho_{11} & \dots  & \rho_{1k} \\
		\vdots    & \ddots & \vdots    \\
		\rho_{1k} & \dots  & \rho_{kk}
		\end{array}
		\right) \\
		\\
		\vec{n} = (n_1,\dots,n_k)
	\end{array}
\end{displaymath}

Up to this point the multivariate default times distribution $F$ can 
be expressed by its marginals $PD_i$ and a multivariate t-Student 
distribution, $t_n(\nu,0,\bar{R})$ with a obligors correlation block 
matrix $\bar{R} = B_k(\vec{n},\vec{1},M)$. The proposition that follows 
gives us the key to reformulate the problem as a multi-factor problem.

% With some minor exceptions 
% (see proposition \ref{prop:gmfamgb}) we can state that any multivariate t-Student 
% distribution with a block correlation matrix can be expressed as a t-Student 
% multi-factor model.

\begin{proposition}[t-Student multi-factor model]
	Let a random vector $X=(X_1,\dots,X_n)$ with a multivariate t-Student 
	distribution $t_n(\nu,0,\bar{R})$ where $\bar{R} = B_k(\vec{n},\vec{1},M)$ 
	is a correlation block matrix and $n_i$ sizes high-enough. 
	Then $X$ can be writen as a t-Student multi-factor model as follows:
	\begin{displaymath}
		X_i^j = \sqrt{\frac{\nu}{V}} \cdot 
		\left( w_i \cdot Z_i + \sqrt{1-w_i^2} \cdot \epsilon_i^j \right)
		\quad \text{ where } \left\{
		\begin{array}{l}
			i = 1, \dots, k \quad \text{ and $k$ is the number of blocks}    \\
			j = 1, \dots, n_i \quad \text{ and $n_i$ is i-th block size}     \\
			V \sim \chi_{\nu}^2, \quad 2 \le \nu \text{ degrees of freedom}  \\
			Z \sim N(0,R), \text{ and $R$ a $k {\times} k$ correlation matrix} \\
			w_i \in (0,1), \text{ are the factor loadings }                  \\
			\epsilon_i^j \sim N(0,1) \text { iid } \forall i,j               \\
			V, Z, \epsilon_i^j \text{ independents } \forall i,j             \\
		\end{array}
		\right.
	\end{displaymath}
	where $w_1,\dots,w_k, R$ satisfy:
	\begin{displaymath}
		\begin{array}{l}
			R_{ii} = 1 \quad i = 1,\dots,k \\
			M_{ij} = w_i \cdot w_j \cdot R_{ij} \quad \forall i,j
		\end{array}
	\end{displaymath}
\end{proposition}
\begin{proof}
	We use the t-Student characterization (proposition\ref{prop:mtschar}),
	$X = \sqrt{\frac{\nu}{V}} \cdot Z$, where $V \sim \chi_{\nu}^2$ and 
	$Z \sim N(0,\bar{R})$ expressing $Z$ as a Gaussian multi-factor model 
	(definition \ref{def:gmfm}). The determination of $R$ and $w_1,\dots,w_n$
	values comes from proposition \ref{prop:gmfigs}. The tag line '$n_i$ sizes
	high-enough' is justified in proposition \ref{prop:gmfamgb}.
\end{proof}

Note that we expressed the multi-factor model in terms of the factor 
loadings and the factors correlation matrix, instead of the the more concise 
covariance matrix. We do this because the factor loadings have a treatment 
distinct than correlations in the estimation of parameters.

%TODO: implications (fixed correlations, economic cicle)

%------------------------------------------------------------------------------
% DETERMINING THE PROBABILITIES OF DEFAULT
%------------------------------------------------------------------------------
\section{Determining the Probabilities of Default}

Each obligor has its own PD depending on its rating and perhaps its
sector. This causes that all obligors with the same sector and rating be
indistingibles together (they are exchangeables) and have the 
same PD. These few PDs can be infered from the transition matrix, 
the construct that contains the relationship between ratings.
Below show three different ways of inferring the PD depending 
upon the amount of information available. All of them give similar 
results when the time unit and evaluation time is reduced (eg. 1 year) 
but differ as this goes away.

\begin{definition}[Transition matrix] 
	The $T$-years transition matrix gives the probability of changing 
	from rating $r_i$ to rating $r_j$ in a period of $T$ years:
	\begin{displaymath}
		M_T = \left(
		\begin{array}{ccc}
			m_{1,1} & \dots  & m_{1,n} \\
			\vdots  & \ddots & \vdots  \\
			m_{n,1} & \dots  & m_{n,n} \\
		\end{array}
		\right)
		\qquad
		m_{i,j} = P(r_i \to r_j;T)
	\end{displaymath}
	where $n$ is the number of ratings and $m_{i,j}$ is the probability that a
	obligor with rating $r_i$ end up having the rating $r_j$ after $T$ years.
	Note that row sums are $1$ and that if we have two consecutives transition 
	matrices, $M_{T_1}$ and $M_{T_2}$, then we can derive 
	$M_{T_1+T_2} = M_{T_1} \cdot M_{T_2}$.
\end{definition}

\begin{example}
	\label{ex:1ytm}
	The following table shows a transition matrix, extracted from 
	\cite[p. 20]{cmetrics:1997} in which the probability that a obligor with 
	rating $AA$ changes to rating $B$ in one year is $0.14\%$. Note that last 
	column contains the 1-year default probabilities for each rating, and the 
	last row corresponds to the \emph{defaulted} rating.
	\begin{figure}[!h]
		\begin{center}
			\begin{tabular}[]{l|rrrrrrrr}
				        & AAA     & AA      & A       & BBB     & BB      & B                  & CCC     & Default  \\
				\hline
				AAA     & $90.81$ & $8.33$  & $0.68$  & $0.06$  & $0.12$  & $0.00$             & $0.00$  & $0.00$   \\
				AA      & $0.70$  & $90.65$ & $7.79$  & $0.64$  & $0.06$  & $\underline{0.14}$ & $0.02$  & $0.00$   \\
				A       & $0.09$  & $2.27$  & $91.05$ & $5.52$  & $0.74$  & $0.26$             & $0.01$  & $0.06$   \\
				BBB     & $0.02$  & $0.33$  & $5.95$  & $86.93$ & $5.30$  & $1.17$             & $0.12$  & $0.18$   \\
				BB      & $0.03$  & $0.14$  & $0.67$  & $7.73$  & $80.53$ & $8.84$             & $1.00$  & $1.06$   \\
				B       & $0.00$  & $0.11$  & $0.24$  & $0.43$  & $6.48$  & $83.46$            & $4.07$  & $5.21$   \\
				CCC     & $0.22$  & $0.00$  & $0.22$  & $1.30$  & $2.38$  & $11.24$            & $64.86$ & $19.78$  \\
				Default & $0.00$  & $0.00$  & $0.00$  & $0.00$  & $0.00$  & $0.00$             & $0.00$  & $100.00$ \\
			\end{tabular}
			\caption{One-year transition matrix \%}
			\label{tmatrix1}
		\end{center}
	\end{figure}
\end{example}

\subsection{From annual PDs}
\label{pdfsv}

In some circumstances the complete transition matrix is not available, 
and we only have the probabilities of default at T-years for each rating, 
$p_1,\dots,p_n$. In the absence of more information, we can considerer 
the following diagonal transition matrix:
\begin{displaymath}
	M_T = \left(
	\begin{array}{cccc}
		1-p_1  & \dots  & 0         & p_1     \\
		\vdots & \ddots & \vdots    & \vdots  \\
		0      & \dots  & 1-p_{n-1} & p_{n-1} \\
		0      & \dots  & 0         & 1       \\
	\end{array}
	\right)
\end{displaymath}

We can derive the PDs from this matrix applying the following 
section \ref{pdftm}, but this simplified case has an explicit
solution stated in the proposition that follows.

\begin{proposition}
A diagonal transition matrix leads to default times with exponential
distributions:
\begin{displaymath}
	\Pr\{T_. \le t\} = 1 - e^{-\lambda t} 
	\quad \text{ where } \lambda = -\ln(1-p_j)
\end{displaymath}
\end{proposition}
\begin{proof}
	We note that ratings are detached from each other. 
	For this reason we do the proof for a generic rating and we
	use the subscripts to indicate the time, not the rating.
	Let $p_t$ the probability of default in the time range $[0,t]$ and
	$q_t=1-p_t$ the probability of survival. We express $p_1$ in term
	of $p_{\frac{1}{n}}$ using the geometric serie formula.
	\begin{displaymath}
		p_1 = p_{\frac{1}{n}} \cdot q_{\frac{1}{n}}^{(n-1)} + 
			p_{\frac{1}{n}} \cdot q_{\frac{1}{n}}^{(n-2)} + \dots + 
			p_{\frac{1}{n}} \cdot q_{\frac{1}{n}} + 
			p_{\frac{1}{n}}
		= p_{\frac{1}{n}} \cdot \frac{1-q_{\frac{1}{n}}^n}{1-q_{\frac{1}{n}}}
		= 1 - q_{\frac{1}{n}}^n
		= 1- (1-p_{\frac{1}{n}})^n
	\end{displaymath}
	This gives:
	\begin{displaymath}
		p_{\frac{1}{n}} = 1-(1-p_1)^{\frac{1}{n}}
	\end{displaymath}
	We use the limit definition of the logarithm function, that is 
	$\ln(x)=\lim_{n \to \infty} n \cdot(x^{\frac{1}{n}}-1)$, to
	found the following limit:
	\begin{displaymath}
		\lim_{n \to \infty} n \cdot p_{\frac{1}{n}} = 
		\lim_{n \to \infty} -n \cdot ((1-p_1)^{\frac{1}{n}} -1) =
		-\ln(1-p_1) = \lambda
	\end{displaymath}
	We use this equivalence and the limit definition of the 
	exponential function to determine the survival probability:
	\begin{displaymath}
		(1-p_1)^t 
		= \left( \lim_{n \to \infty} (1-p_{\frac{1}{n}})^n \right)^t
		= \left(\lim_{n \to \infty} (1-\frac{\lambda}{n})^n \right)^t
		= e^{-\lambda \cdot t}
	\end{displaymath}
\end{proof}

If $T$ is a reduced time horizon (eg. 1 year), then the linear function
can be a good-enought approximation. To see this we use the Taylor series
of the exponential and the logarithm functions:
\begin{displaymath}
	\begin{array}{l}
		e^x = 1 +x + \frac{x^2}{2!} + \frac{x^3}{3!} + \dots
		\\
		\ln(1-x) = -x - \frac{x^2}{2} - \frac{x^3}{3} + \dots
		\\
		\Pr\{T. \le t\} = 1-e^{-\lambda\cdot t} \approx
		1 - (1-\lambda \cdot t) = \lambda \cdot t = 
		- \ln(1-p) \cdot t \approx p \cdot t
	\end{array}
\end{displaymath}

\begin{example}
	\label{ex:pdfsv}
	Supose that we only know the ratings annual probabilities of default 
	and that these values are those from the 1-year regularized transition 
	matrix of example \ref{ex:1ytm}. In this case, the diagonal transition 
	matrix is:
	\begin{displaymath}
		M_1 = \left(
		\small
		\begin{array}{cccccccc}
		99.9991 & 0 & 0 & 0 & 0 & 0 & 0 & 0.0009 \\
		0 & 99.9923 & 0 & 0 & 0 & 0 & 0 & 0.0077 \\
		0 & 0 & 99.9400 & 0 & 0 & 0 & 0 & 0.0600 \\
		0 & 0 & 0 & 99.8200 & 0 & 0 & 0 & 0.1800 \\
		0 & 0 & 0 & 0 & 98.9401 & 0 & 0 & 1.0599 \\
		0 & 0 & 0 & 0 & 0 & 94.7997 & 0 & 5.2003 \\
		0 & 0 & 0 & 0 & 0 & 0 & 80.2154 & 19.7846 \\
		0 & 0 & 0 & 0 & 0 & 0 & 0 & 100 \\
		\end{array}
		\right)
	\end{displaymath}
	We determine the PDs function for each rating using the proposition 
	\ref{prop:pdftm}, that is, considering that default times are exponential
	distributions. Results are displayed in figure \ref{fig:pdfsv}. Observe 
	that values around $T=1$ are similar to those of example \ref{ex:pdftm}, 
	but they differ as they move away from this.
\end{example}
\begin{figure}[ht]
	\centering
	\subfloat[Probability of Default]{
		\includegraphics[width=7cm]{pdfsv1}
	}
	\subfloat[Probability of Default (zoom)]{
		\includegraphics[width=7cm]{pdfsv2}
	}
	\caption{PDs derived from annual PDs}
	\label{fig:pdfsv}
\end{figure}

\subsection{From transition matrix}
\label{pdftm}

This approach implies that transition probabilities remains contants 
over time undermining the economic cicle effect. In practice, it is 
equivalent to consider an averaged economic cicle.

\begin{proposition}[Scaled transition matrix]
	The transition matrix can be scaled in time by using the following rules:
	\begin{itemize}
		\item $M_{k \cdot T} = M_{T}^k$
		\item $M_{\frac{T}{k}} = \sqrt[k]{M_{T}}$
	\end{itemize}
\end{proposition}

The root of a matrix $M$ can be obtained using the spectral decomposition
$M = P \cdot D \cdot P^{-1}$, where $P$ and $D$ are the eigenvectors and
eigenvalues matrices of $M$, doing $M^{\gamma} = P \cdot D^{\gamma} \cdot P^{-1}$

Sometimes, the scaled transition matrix does not satisfy the Markov conditions
(the row sum is equal to one, and all elements are non-negatives). In this case, 
we need to transform this matrix to the relevant Markov matrix. This process is 
called regularization. Below is exposed the QOM regularization algorithm 
extracted from \cite{kreinin:2001}.

\begin{algorithm}[Transition matrix regularization]
	The QOM (Quasi-Optimization of the root Matrix) algorithm regularizes a 
	$n {\times} n$ transition matrix $M$, row by row. The steps to 
	regularize the $i$-th row are:
	\begin{enumerate}
		\item Compute the difference between the row sum and one. 
		Divide by $n$ and subtract this value from all non-zero components:
		\begin{displaymath}
			m_{ij} \ne 0 
			\Longrightarrow 
			m_{ij} = m_{ij} - \frac{1}{n} \left( \sum_{k=1}^{n} m_{ik} - 1\right)
		\end{displaymath}
		\item If all the row elements are non-negative and sum to one, 
		then stop, as the row is regularized.
		\item Fix any negative row element to zero and go to Step 1.
	\end{enumerate}
	
	Apply the previous algorithm for every row. The algorithm stops after $m$ 
	steps, where $m \le n$ (Merkoulovitch 2000). The final matrix is a regularized
	matrix. 
\end{algorithm}

\begin{proposition}[PDs derived from transition matrix]
	\label{prop:pdftm}
	Let $M_T$ a transition matrix, then the PD for an obligor with 
	rating $r_j$ is:
	\begin{displaymath}
		\Pr\{T_. \le t\} = \left( M_t \right)_{j,n}
	\end{displaymath}
	where $T_.$ is the obligor default time, $j$ is the index of the obligor's
	rating, $n$ is the index of the \emph{defaulted} rating, $M_t$ is the 
	transition matrix scaled to time $t$, and $(M)_{i,j}$ is the matrix element
	in the i-th row and j-th column.
\end{proposition}

\begin{example}
	\label{ex:pdftm}
	We derive the PD for each rating induced by the transition matrix exposed
	in the example \ref{ex:1ytm}. As first step, we scale the 1-year transition 
	matrix $M_1$ to the 1-month transition matrix $M_{\frac{1}{12}}$.
	\begin{displaymath}
		M_{\frac{1}{12}} = \left(
		\small
		\begin{array}{cccccccc}
			99.1972 &  0.7588 &  0.0320 &  0.0020 &  0.0112 & -0.0011 & -0.0001 &   0.0000 \\
			 0.0635 & 99.1744 &  0.7083 &  0.0392 &  0.0015 &  0.0120 &  0.0018 &  -0.0007 \\
			 0.0074 &  0.2057 & 99.1980 &  0.5102 &  0.0557 &  0.0189 & -0.0001 &   0.0042 \\
			 0.0014 &  0.0239 &  0.5507 & 98.8021 &  0.5164 &  0.0871 &  0.0077 &   0.0106 \\
			 0.0027 &  0.0113 &  0.0396 &  0.7581 & 98.1557 &  0.8774 &  0.0889 &   0.0665 \\
			-0.0007 &  0.0098 &  0.0196 &  0.0111 &  0.6447 & 98.4443 &  0.4463 &   0.4240 \\
			 0.0233 & -0.0023 &  0.0170 &  0.1287 &  0.2166 &  1.2298 & 96.4213 &   1.9667 \\
			 0.0000 &  0.0000 &  0.0000 &  0.0000 &  0.0000 &  0.0000 &  0.0000 & 100 \\
		\end{array}
		\right)
	\end{displaymath}
	We observe that $M_{\frac{1}{12}}$ is not a regular matrix due to negative
	values. We apply the QOM algorithm to regularize it. We call the 1-year 
	regularized transition matrix to $\bar{M}_1 = \bar{M}_{\frac{1}{12}}^{12}$.
	\begin{displaymath}
		\bar{M}_{\frac{1}{12}} = \left(
		\small
		\begin{array}{cccccccc}
			99.1969 &  0.7586 &  0.0317 &  0.0018 &  0.0110 &  0.0000 &  0.0000 &   0.0000 \\
			 0.0634 & 99.1744 &  0.7082 &  0.0391 &  0.0014 &  0.0119 &  0.0017 &   0.0000 \\
			 0.0074 &  0.2057 & 99.1980 &  0.5102 &  0.0557 &  0.0189 &  0.0000 &   0.0041 \\
			 0.0014 &  0.0239 &  0.5507 & 98.8021 &  0.5164 &  0.0871 &  0.0077 &   0.0106 \\
			 0.0027 &  0.0112 &  0.0395 &  0.7581 & 98.1557 &  0.8774 &  0.0889 &   0.0665 \\
			 0.0000 &  0.0099 &  0.0197 &  0.0111 &  0.6447 & 98.4444 &  0.4463 &   0.4240 \\
			 0.0228 &  0.0000 &  0.0165 &  0.1282 &  0.2161 &  1.2293 & 96.4208 &   1.9663 \\
			 0.0000 &  0.0000 &  0.0000 &  0.0000 &  0.0000 &  0.0000 &  0.0000 & 100 \\
		\end{array}
		\right)
	\end{displaymath}
	Finally we use the proposition \ref{prop:pdftm} to determine the 
	PD function for each rating and month. Results are displayed in figure 
	\ref{fig:pdftm}.
\end{example}
\begin{figure}[ht]
	\centering
	\subfloat[Probability of Default]{
		\includegraphics[width=7cm]{pdftm1}
	}
	\subfloat[Probability of Default (zoom)]{
		\includegraphics[width=7cm]{pdftm2}
	}
	\caption{PDs derived from transition matrix}
	\label{fig:pdftm}
\end{figure}

\subsection{From advanced transition matrix model}

There are financial institutions that may have models to forecast 
the transition matrix using some economic indicators like GDP
or inflation. We note as $M_T(t)$ the T-period transition matrix
at time $t$. This matrix depends of the forecasted indicators at 
$t$ in the form $M_T(\theta_1(t),\dots,\theta_k(t))$. In these 
cases, the PDs functions can be obtained composing successively
the transition matrices for each T-period. The P for an obligor
with rating $r_j$ is:
\begin{displaymath}
\Pr\{T_. \le t\} = \left(
	\left( \prod_{i=1}^{[t/T]} M_T(i) \right) \cdot 
	M_{t-T\cdot[t/T]}\left([t/T]+1\right) 
	\right)_{j, n}
\end{displaymath}
where $[x]$ is the integer part of $x$, $T_.$ is the obligor default time, 
$j$ is the index of the obligor's rating, $n$ is the index of the 
\emph{defaulted} rating, $M_t(i)$ is the T-period transition matrix 
evaluated at time $i$ and scaled to time $t$, and $(M)_{i,j}$ is the 
matrix element in the i-th row and j-th column.

The PDs functions derived from an advanced transition matrix model may 
have more or less pronounced steps depending on the different stages of 
the economic cycle. This approach is the most suitable for risk estimates 
in the medium and long term.


%==============================================================================
% ESTIMATING PARAMETERS
%==============================================================================
\chapter{Estimating Parameters}

We want to estimate the parameters of the multivariate default times model.
All of them are known except those related to t-Student copula. The 
parameters to be estimated are the degrees of freedom $\nu$, and the 
obligors correlation matrix $\bar{R}$. Equivalently, considering the 
multi-factor formulation, the parameters to be estimated are the degrees
of freedom $\nu$, the factor loadings $w_i$, and the factors correlation
matrix $R$.

\begin{definition}[Annual number of defaults]
	We define the annual number of defaults by sector and rating like a
	discrete multivariate random variable $K=(K_{11}, \dots, K_{sr})$ where:
	\begin{displaymath}
		K_{ij} = \left\{
		\begin{array}{c}
			\text{number of defaults in the sector $i$ in a period of} \\
			\text{1-year having a rating $j$ at the begining of the period}
		\end{array}
		\right\}
	\end{displaymath}
	taking in account that:
	\begin{displaymath}
		N_{ij} = \left\{
		\begin{array}{c}
			\text{number of obligors in the sector $i$ in a period of} \\
			\text{1-year having a rating $j$ at the begining of the period}
		\end{array}
		\right\}
	\end{displaymath}
	Note that $K_{ij} \le N_{ij}$.
	When the subscript only has one index ($K_{i}$ and $N_{i}$) this means 
	that values are aggregated by sector. We use the superscript to indicate 
	the observation at time $t$. Thus, $K_{ij}^t$ and $N_{ij}^t$ are the 
	corresponding number of obligors and defaults by sector $i$ and rating 
	$j$ observed at year $t$. 
\end{definition}

% It is possible that the there is no historical records disaggregated at 
% the rating level. In these cases, when the historical records are 
% $\left\{N_{s}^t, K_{s}^t \right\}_{t=1,\dots,T}$ without the counts by 
% rating, we can use the following approximation:
% \begin{displaymath}
	% K_{ij}^t = K_{i}^t \cdot \frac{\lambda_{ij}^t \cdot p_j}{\displaystyle \sum \lambda_{ik}^t \cdot p_k}
	% \quad \text{ where }
	% \lambda_{ij}^t \approx \frac{\text{\# obligors sector $i$ rating $j$}}{\text{\# obligors sector $i$}}
% \end{displaymath}
% Values $\lambda_{ij}^t$ depends on the characteristics of the portfolio 
% and the economic cicle and requires to be estimated based on historical 
% data and current PD models.

\begin{example}[]
We have two sectors, $S1$ and $S2$, and four ratings, $A, B, C, D$ where 
$D$ is the defaulted status. We have collected the observations displayed
in table \ref{table:histdata}.
This example has a number of ratings and sectors less than the previous 
examples for practical reasons (otherwise data tables do not fit 
in the width of the page).
\begin{table}[h!]
	\centering
	\begin{tabular}{cc|c|c|c||c|c|c|  c  |c|c|c||c|c|c|}
	%\centering
	\cline{3-8} \cline{10-15}
	& & \multicolumn{6}{|c|}{N (\# obligors)} & & \multicolumn{6}{|c|}{K (\# defaults)} \\
	\cline{3-8} \cline{10-15}
	& & \multicolumn{3}{|c||}{S1} & \multicolumn{3}{|c|}{S2} & & \multicolumn{3}{|c||}{S1} & \multicolumn{3}{|c|}{S2} \\
	\cline{1-1} \cline{3-8} \cline{10-15}
	\multicolumn{1}{|c|}{Year} & & A & B & C & A & B & C & & A & B & C & A & B & C \\
	\cline{1-1} \cline{3-8} \cline{10-15}
	\multicolumn{1}{|c|}{1} & & 529 & 932 & 293 & 685 & 1249 & 206 & & 3 & 12 & 15 & 3 & 25 & 10 \\
	\cline{1-1} \cline{3-8} \cline{10-15}
	\multicolumn{1}{|c|}{2} & & 522 & 977 & 278 & 638 & 1315 & 194 & & 1 & 18 & 13 & 7 & 28 & 8 \\
	\cline{1-1} \cline{3-8} \cline{10-15}
	\multicolumn{1}{|c|}{\vdots} & & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
	\cline{1-1} \cline{3-8} \cline{10-15}
	\multicolumn{1}{|c|}{20} & & 492 & 962 & 310 & 602 & 1227 & 183 & & 6 & 28 & 21 & 4 & 31 & 16 \\
	\cline{1-1} \cline{3-8} \cline{10-15}
	\end{tabular}
	\caption{Example of historical records}
	\label{table:histdata}
\end{table}
\end{example}

%------------------------------------------------------------------------------
% DISTRIBUTION OF THE NUMBERS OF DEFAULTS
%------------------------------------------------------------------------------
\section{Distribution of the Number of Defaults}

Before to proced to estimate the parameters we need to know the density
of the number of observed defaults in order to define a likelihood 
function. In this section we derive this distribution from the multivariate
default times distribution. More info at \cite{gordy:2002} \cite{roncalli:2004}.

\begin{proposition}[Density of the annual number of defaults (I)]
	The density (pdf) of the annual number of defaults, assuming that default 
	times are distributed according to a multivariate block t-Student distribution
	with $\nu$ degrees of freedom, and $n {\times} n$ obligors block correlation 
	matrix $\bar{R} = B_k(\vec{n},\vec{1},M)$, is:
	\begin{displaymath}
		\begin{array}{l}
			K(k_{11},\dots,k_{sr}\ ;\ \nu, \bar{R}) = 
			\Pr\{K_{11}=k_{11},\dots,K_{sr}=k_{sr}\ ;\ \nu, \bar{R}\} = \\
			\\
			= \left( \displaystyle \prod_{i=1}^s \prod_{j=1}^r \binom{n_{ij}}{k_{ij}} \right) \cdot       
			\displaystyle                                                                                 
			\underbrace{\int_{-\infty}^{t_{\nu}^{-1}(p_1)}}_{k_{11} \text{ times}}                        
			\underbrace{\int_{t_{\nu}^{-1}(p_1)}^{\infty}}_{n_{11}-k_{11} \text{ times}}                  
			\dots                                                                                         
			\underbrace{\int_{-\infty}^{t_{\nu}^{-1}(p_r)}}_{k_{sr} \text{ times}}                        
			\underbrace{\int_{t_{\nu}^{-1}(p_r)}^{\infty}}_{n_{sr}-k_{sr} \text{ times}}                  
			f(x_1,\dots,x_n) \ud x_1 \dots \ud x_n                                                        
		\end{array}
	\end{displaymath}
	where $n_{ij}$ is the number of obligors in the i-th sector with the 
	j-th rating, $k_{ij}$ is the number of defaults in the i-th sector 
	with the j-th rating, $n = \sum n_{ij}$ is the number of obligor in the
	portfolio, $f()$ is the pdf of $t_n(\nu,\bar{R})$, and $t_{\nu}^{-1}$ is 
	the inverse of the univariate t-Student cdf. The combinatorial coeficients
	takes in account all the combinations of exchangeable obligors.
\end{proposition}

We don't known an analitical expression for the density of the annual 
number of defaults. For this reason we try to solve the problem recurring 
to the multi-factor formulation.

\begin{proposition}[Conditioned density of the annual number of defaults]
	The conditioned density (pdf) of the annual number of defaults, assuming 
	that default times are distributed according to a t-Student multi-factor 
	model with $\nu$ degrees of freedom, factor loadings $w_i$, and 
	factors correlations $R$ is:
	\begin{displaymath}
		\begin{array}{l}
			K(k_{11},\dots,k_{sr} \mid v,\vec{z}\ ;\ \nu,\vec{w}, R) = 
			\Pr\{K_{11}=k_{11},\dots,K_{sr}=k_{sr} \mid v,\vec{z}\ ;\ \nu, \vec{w}, R\} = \\
			                                                                                                                                 \\
			= \displaystyle \prod_{i=1}^s \prod_{j=1}^r \binom{n_{ij}}{k_{ij}} \cdot
			H_{ij}(v,z_i)^{k_{ij}} \cdot
			\left( 1 - H_{ij}(v,z_i) \right)^{n_{ij}-k_{ij}}
		\end{array}
	\end{displaymath}
	where
	\begin{displaymath}
		H_{ij}(v,z_i) = \phi\left(  
		\frac{\sqrt{\frac{v}{\nu}} \cdot t_{\nu}^{-1}(p_j) - w_i\cdot z_i}{\sqrt{1-w_i^2}}
		\right)
	\end{displaymath}
	and $n_{ij}$ is the number of obligors in the i-th sector with the 
	j-th rating, $k_{ij}$ is the number of defaults in the i-th sector 
	with the j-th rating, $\phi$ is the pdf of the univariate $N(0,1)$
	, and $t_{\nu}^{-1}$ is the inverse of the univariate t-Student cdf. 
	The combinatorial coeficients takes in account all the combinations 
	of exchangeable obligors.
\end{proposition}
\begin{proof}
	Let $H_{ij}$ the probability that an obligor belonging to sector $i$
	with initial rating $j$ defaults the first year conditioned to $z_i$ 
	and $v$. We use the pdf of the default times distribution (see proposition 
	\ref{prop:dtd}) to assess it value:
	\begin{displaymath}
		H_{ij}(v,z_i) = 
		\Pr\{T_k \le 1 \mid v, z_i\} = 
		\Pr\{ X_k \le t_{\nu}^{-1}(F_k(1)) \mid v, z_i\} = 
		\Pr\{ X_k \le t_{\nu}^{-1}(p_j) \mid v, z_i\}
	\end{displaymath}
	where the k-th obligor belongs to sector $i$ and has rating $j$, 
	$T_k$ is the k-th component of the multivariate default 
	times, $F_k$ is PD of the k-th obligor, and $X_k$ is the 
	k-th component of the multivariate t-Student. Now express 
	$X$ in the multi-factor form:
	\begin{displaymath}
		H_{ij}(v,z_i) = \Pr \left\{ 
		\sqrt{\frac{\nu}{v}} \cdot \left( w_i \cdot z_i + \sqrt{1-w_i^2} \cdot \epsilon\right)
		\le t_{\nu}^{-1}(p_j)
		\right\}
	\end{displaymath}
	Because $v$ and $z_i$ are fixed and independent from $\epsilon \sim N(0,1)$, we obtain:
	\begin{displaymath}
		H_{ij}(v,z_i) = \phi\left(  
		\frac{\sqrt{\frac{v}{\nu}} \cdot t_{\nu}^{-1}(p_j) - w_i\cdot z_i}{\sqrt{1-w_i^2}}
		\right)
	\end{displaymath}
	Once the probability of default by one obligor, the probability of 
	observing $k$ failures in a set of $n$ independent obligors follows 
	a binomial distribution:
	\begin{displaymath}
		\text{Bin}(k;n,p) = \binom{n}{k} \cdot p^k \cdot (1-p)^{n-k}
	\end{displaymath}
	The product for all sectors and ratings gives the stated formula. 
	We can do the product because $v$ and $z_i$ are fixed.
\end{proof}

\begin{corollary}[Density of the annual number of defaults (II)]
	We can express the density of the annual number of defaults using 
	the conditioned density:
	\begin{displaymath}
		\begin{array}{l}
			K(k_{11},\dots,k_{sr}\ ;\ \nu, \vec{w}, R) =                \\
			\\
			\displaystyle \int_0^{\infty} \int_{\mathbb{R}^k}                                         
			\psi(v) \cdot \phi(\vec{z}) \cdot
			K(k_{11},\dots,k_{sr} \mid v,\vec{z}\ ;\ \nu,\vec{w}, R) 
			\ud z_1 \dots \ud z_k \ud v
		\end{array}
	\end{displaymath}
	where $\psi$ is the pdf of $\chi_{\nu}^2$, and $\phi$ is the pdf of $N(0,R)$.
\end{corollary}

%------------------------------------------------------------------------------
% BAYESSIAN INFERENCE
%------------------------------------------------------------------------------
\section{Bayessian Inference}

\begin{wrapfigure}{r}{0.4\textwidth}
%\begin{figure}[!hbt]
\vspace{-20pt}
\begin{center}
\includegraphics[width=0.38\textwidth]{ccbnd}
\end{center}
\vspace{-10pt}
\caption{Distr. of correlation coefficient of the bivariate Normal with $\rho=0.2$ and sample size $20$.}
\vspace{-10pt}
\label{fig:ccbnd}
%\end{figure}
\end{wrapfigure}
Parameters $w_i$ and $R$ are variances and correlations that must be 
estimated. It is difficult to estimate this type of statistics. To ilustrate
this we supose a simplified problem: estimate the correlation of a bivariate 
Normal distribution with $\rho=0.2$ from a sample size of $20$. Figure 
\ref{fig:ccbnd} displays the distribution of the correlation 
coefficient \cite[pp. 217-221]{kenney:1951}. We observe that the 
uncertainty is important. In fact, the probability that we observe 
a negative correlation coefficient from a sample size of $20$ 
bivariate Normals with $\rho=0.2$ is significative. Our goal
is the inverse case, we have a correlation coefficient from a sample
size of $20$ observations and we have to estimate the original $\rho$.
The previous observation about the dispersion indicates that the 
searched value will also have an important dispersion.
This is exacerbated by the fact that some of our variables
are latents, and that we are estimating from observations of type
count-data. After this, considering the estimated parameters as 
unique values, like the Maximum Likelihood estimator, is a naive and 
risky positioning. The bayessian approach seems  more appropriate 
\cite{gossl:2005} \cite{tarashev:2010} because it takes into account 
the uncertainty of the parameters. Later we will see how to transfer 
this uncertainty to the assessment of credit risk.

Bayesian statistics differ from the classical statistical 
theory since all unknown parameters are considered as random 
variables. We want calculate the distribution $f(\theta \mid y)$ 
of the parameters $\theta$ given the observed data $y$. 
According to the Bayes theorem, this can be written as:
\begin{displaymath}
	f(\theta \mid y) = \frac{f(y \mid \theta) \cdot f(\theta)}{f(y)} \propto f(y \mid \theta) \cdot f(\theta)
\end{displaymath}

We call \emph{posterior distribution} to $f(\theta \mid y)$ and 
\emph{prior distribution} to $f(y)$. This prior distribution 
expresses the information available to the researcher before 
any data are involved in the statistical analysis. $f(y \mid \theta)$ 
is the probability of observing $y$ given $\theta$, and is also 
known as the likelihood.
\begin{displaymath}
	f(y \mid \theta) = \prod_{i=1}^n f(y_i \mid \theta)
\end{displaymath}

%------------------------------------------------------------------------------
% METROPOLIS-HASTINGS ALGORITHM
%------------------------------------------------------------------------------
\section{Metropolis-Hastings Algorithm}

TODO \cite{ntzoufras:2009}

\begin{algorithm}[Metropolis-Hastings]
	Let us assume a target distribution $f(x)$ from which we wish to generate a 
	sample of size $T$. The Metropolis-Hastings algorithm can be described by the 
	following iterative steps; where $x^{(t)}$ is the vector of generated values 
	in the $t$-th iteration of the algorithm:
	\begin{enumerate}
		\item Set initial values $x^{(0)}$
		\item For $t=1,\dots,T$ repeat the following steps
		\begin{itemize}
			\item Set $x=x^{(t-1)}$
			\item Let $x'$ a random value from the proposal distribution $q(x \to x’)=q(x' \mid x)$
			\item Calculate the acceptance rate 
			$\alpha = \min\left(1,\frac{f(x') \cdot q(x \mid x')}{f(x) \cdot q(x' \mid x)}\right)$
			\item Update $x^{(t)}=\left\{
			\begin{array}{ll}
				x'        & \text{ with probability } \alpha   \\
				x^{(t-1)} & \text{ with probability } 1-\alpha 
			\end{array}\right.$ 
		\end{itemize}
	\end{enumerate}
\end{algorithm}

%TODO: list ergodic properties
%TODO: referenciar llibre WinBugs


\textbf{Bayesian inference}.
The Metropolis-Hastings algorithm outlined above can be directly implemented to do
Bayesian inference by substituting $x$ by the unknow parameters, $\theta$, and 
the target distribution $f(x)$ by the posterior distribution $f(\theta \mid y)$. Then 
the acceptance rate becomes:
\begin{displaymath}
	\alpha = \min\left(1,\frac{f(\theta' \mid y) \cdot q(\theta \mid \theta')}{f(\theta \mid y) \cdot q(\theta' \mid \theta)}\right) = \min\left(1,\frac{f(y \mid \theta') \cdot f(\theta') \cdot q(\theta \mid \theta')}{f(y \mid \theta)  \cdot f(\theta) \cdot q(\theta' \mid \theta)}\right)
\end{displaymath}


\textbf{Random-walk Metropolis-Hastings} is a special case with symmetric proposals
$q(\theta' \mid \theta) = q(\theta \mid \theta')$ where $q(\theta' \mid \theta) \equiv N(\theta,S)$. 
In this case the acceptance rate depends only on the posterior distribution
and, in the Bayesian inference Metropolis-Hastings case, becomes:
\begin{displaymath}
	\alpha = 
	\min\left(1,\frac{f(y \mid \theta') \cdot f(\theta') \cdot q(\theta \mid \theta')}{f(y \mid \theta)  \cdot f(\theta) \cdot q(\theta' \mid \theta)}\right) = 
	\min\left(1,\frac{f(y \mid \theta') \cdot f(\theta')}{f(y \mid \theta) \cdot f(\theta)}\right)
\end{displaymath}


\textbf{Metropolis-Hastings using logarithms}.
The product of functions involves complicated expressions and accuracy 
problems. For this reason it is usual to operate with logarithms. The 
logarithmic version of the acceptance rate, in the Bayesian inference 
Metropolis-Hastings case, becomes:
\begin{displaymath}
	\begin{array}{rl}
		\ln(\alpha) = & \min \left( \ln(1),  
		\ln \left(\frac{f(y \mid \theta') \cdot f(\theta')}{f(y \mid \theta) \cdot f(\theta)}\right)
		\right) = \\
		= & \min \left( 0,
		\ln f(y \mid \theta') + \ln f(\theta') - \ln f(y \mid \theta) - \ln f(\theta)
		\right)
	\end{array}
\end{displaymath}

\textbf{Single-component Metropolis-Hastings} algorithm consist in update sequentially 
univariate components using Metropolis-Hastings steps. 
One generated observation $\theta^{(t)}$ is obtained after updating all 
components of the parameter vector. Generally, the sequence of updating the 
elements of $\theta$ does not influence the convergence of the algorithm.
We use the notation $\theta_{\backslash j}$ to indicate the vector $\theta$ 
excluding its j-th component [ i.e., $\theta_{\backslash j} = 
(\theta_1,\dots,\theta_{j-1},\theta_{j+1},\dots,\theta_{d})$ ].

\begin{algorithm}[Bayesian inference Metropolis-Hastings] \ 
\label{alg:bimh}
	\begin{enumerate}
		\item Set initial values $\theta^{(0)}$
		\item For $t=1,\dots,T$ repeat the following steps
		\begin{itemize}
			\item Set $\theta=\theta^{(t-1)}$
			\item For $j=1,\dots,d$ repeat the following steps
			\begin{enumerate}[label=\alph*.]
				\item $\theta_j' = N(\theta_j,S_j)$
				\item Calculate the logarithm of the acceptance rate \\
				$\ln(\alpha) = \min \left( 0,
				\ln f(y \mid \theta_j',\theta_{\backslash j}) + 
				\ln f(\theta_j',\theta_{\backslash j}) - 
				\ln f(y \mid \theta_j,\theta_{\backslash j}) - 
				\ln f(\theta_j,\theta_{\backslash j})
				\right)$
				\item Simulate $u \sim U(0,1)$
				\item Update $\theta_j=\left\{
				\begin{array}{ll}
					\theta_j' & \text{ if } \ln(u) < \ln(\alpha) \\
					\theta_j  & \text{ otherwise }               
				\end{array}\right.$ 
			\end{enumerate}
			\item Set $\theta^{(t)}=\theta$
		\end{itemize}
	\end{enumerate}
\end{algorithm}

%------------------------------------------------------------------------------
% ESTIMATION OF PARAMETERS
%------------------------------------------------------------------------------
\section{Estimation of Parameters}

\begin{definition}[Conditioned likelihood]
Let a set of observations $\{K^t, N^t\}_{t=1,\dots,T}$ where $N^t$ 
and $K^t$ are vectors representing the number of obligors and defaulted 
obligors in each sector-rating bucket. We define the conditional 
likelihood of these observations as:
\begin{displaymath}
	\begin{array}{l}
		L(\nu,\vec{w},R \mid v^1,\vec{z}^1,\dots,v^T,\vec{z}^T\ ;\ K^1,\dots,K^T) = \\
		\displaystyle \prod_{t=1}^T K(k_{11}^t,\dots,k_{sr}^t \mid v^t,\vec{z}^t\ ;\ \nu,\vec{w},R) = \\
		\displaystyle
		\prod_{t=1}^T \prod_{i=1}^s \prod_{j=1}^r 
		\binom{n_{ij}^t}{k_{ij}^t} \cdot
		H_{ij}(v^t,z_i^t)^{k_{ij}^t} \cdot
		\left( 1 - H_{ij}(v^t,z_i^t) \right)^{n_{ij}^t-k_{ij}^t}
	\end{array}
\end{displaymath}
Note that the parameters to be infered are $\nu,\vec{w},R$ and the
latent variables $v^1,\vec{z}^1,\dots,v^T,\vec{z}^T$.
\end{definition}

\begin{proposition}[Parameters estimation]
	We can estimate the parameters of the conditioned likelihood using
	the Bayessian framework and Metropolis-Hastings algorithm 
	(see algorithm \ref{alg:bimh}) with the following rules:
	\begin{itemize}
		\item parameters $\theta \equiv \{ \nu,\vec{w},R,v^1,\vec{z}^1,\dots,v^T,\vec{z}^T\}$
		\item observations $y \equiv \{K^t, N^t\}_{t=1,\dots,T}$
		\item likelihood $f(y \mid \theta) \equiv L(\nu,\vec{w},R  \mid  v^1,\vec{z}^1,\dots,v^T,\vec{z}^T\ ;\ K^1,\dots,K^T)$
		\item proposal distributions $q(\theta_j \mid \theta_j') \sim N(\theta,\sigma_j)$
		\item prior distribution $f(\nu) \sim \text{Unif}(2,1000)$
		\item prior distribution $f(w_i) \sim \text{Unif}(0,1) \quad i=1,\dots,k$
		\item prior distribution $f(r_{ij}) \sim \Upsilon(\vec{z}^1,\dots,\vec{z}^T,R) \quad i=1,\dots,k, \quad j=(i+1),\dots,k$
		\item prior distribution $f(\vec{z}^t) \sim N(\vec{0},R) \quad t=1,\dots,T$
		\item prior distribution $f(v^t) \sim \chi_{\nu}^2 \quad t=1,\dots,T$
	\end{itemize}
	For the prior distributions of $r_{ij}$ we set the likelihood distribution
	of the latent variables $\vec{z}^t$. The pdf of the distribution 
	$\Upsilon(\vec{z}^1,\dots,\vec{z}^T,R)$ is:
	%hyperparameters, hyperdistributions
	\begin{displaymath}
		f(r_{ij}) = f(r; i,j,R) = \frac
		{\displaystyle \prod_{t=1}^{T} \phi\left( \vec{z}^t; \vec{0}, R(r,i,j) \right)}
		{\displaystyle \int \prod_{t=1}^{T} \phi\left( \vec{z}^t; \vec{0}, R(r,i,j) \right) \ud r}
	\end{displaymath}
	where $\phi$ is the pdf of the multivariate $N(0,R)$ distribution,
	and $R(r,i,j)$ is the matrix $R$ with the cell $(i,j)$ value 
	replaced by $r$. We don't need to know the limits of the integral
	because this is constant and cancels into the M-H algorithm.
\end{proposition}

\begin{proposition}[Robbins-Monro process]
CAL MILLORAR MOLT AIXO. \cite{garthwaite:2010}
proceso de Robbins-Monro tal como se indica en [¿24?].
	\begin{displaymath}
		\sigma_{i+1} = \left\{
		\begin{array}{ll}
			\sigma_i \cdot \left( 1 + \frac{1}{p \cdot i} \right) & \text{if $y$ is accepted} \\
			\sigma_i \cdot \left( 1 - \frac{1}{(1-p) \cdot i} \right) & \text{if $y$ is rejected} \\
		\end{array}
		\right.
	\end{displaymath}
	we take an arbitrary starting value $\sigma_0$.
\end{proposition}


%==============================================================================
% MODELING PORTFOLIO LOSS
%==============================================================================
\chapter{Modeling Portfolio Loss}

\section{Portfolio Loss Distribution}

Let a portfolio where we have the obligor default times
$(T_1,\dots,T_n)$ modeled by its PD over time and a
t-Student copula. For each obligor we know its exposure

Monte Carlo, risk statistics (el, var, es), standar error estimates,
variance reduction methods (antithetic, Latin Hypercube Sampling),
speed-up techniques (function composition), function approximation
(splines linear/cubic)


%==============================================================================
% APPENDICES
% TODO: create its own header, numeration, etc.
%==============================================================================
\appendix
\chapterimage{chapter_head_1.pdf}
\chapter{Appendices}

%------------------------------------------------------------------------------
% COPULA BASICS
%------------------------------------------------------------------------------
\section{Copula Basics}
\label{ap:copula_basics}

It is common to use correlation as a measure of dependency between random 
variables. In most cases, this measure does not fully reflect the structure 
of dependence between them. Figure \ref{fig:copula_impact} displays two
cases with the same mean, marginals and correlations but a distinct risk
profile because its underlying  dependence structure is distinct (Gaussian 
copula vs. t-Student(3) copula). The mathematical concept that does reflect 
the structure of dependence between random variables, however, is the copula, 
which we define below. The world of copulas is vast and very interesting. 
See \cite{embrechts:2002} \cite{mcneil:2005} for a pleasant and detailed 
introduction to copulas.

\begin{figure}[!hbt]
\begin{center}
\includegraphics[height=10cm]{ercim78}
\caption{Impact of correlation and copula selection on portfolio loss distribution}
\label{fig:copula_impact}
\end{center}
\end{figure}

\begin{definition}[Copula]
	A copula function, $C$, is a multivariate distribution defined on the 
	unit hypercube $[0,1]^d$ with standard uniform marginals. 
	More precisely,
	\begin{displaymath}
		C(u_1, \dots, u_d) = Pr\{U_1 \le u_1, \dots, U_d \le u_d\}
	\end{displaymath}
	where $U_i \sim \text{Uniform}(0,1) \text{ for } i = 1,\dots, d$.
\end{definition}

Sklar's theorem \cite{sklar:1959} states that any multivariate 
distribution with continuous marginals can be decomposed into the marginals and 
a copula that reflects the structure of dependence between them. Later, we will 
use this statement to define and simulate the t-Student copula.

%%TODO: POSAR REFERENCIA
\begin{theorem}[Sklar's theorem]
	\label{thm:sklar}
	Let $F$ be an $d$-dimensional distribution function with margins $F_1,\dots,F_d$.
	Then there exists an $d$-copula $C$ such that for all $x \in \mathbb{R}^d$,
	\begin{displaymath}
		F(x_1,\dots,x_d) = C(F_1(x_1),\dots,F_d(x_d))
	\end{displaymath}
	If $F_1,\dots,F_d$ are all continuous, the $C$ is unique; otherwise $C$ is uniquely
	determined on $\text{Ran}F_1 \times \dots \times \text{Ran}F_d$.
	Conversely, if $C$ is an $d$-copula and $F_1,\dots,F_d$ are distributions functions,
	then the function $F$ defined above is an $d$-dimensional distribution function
	with margins $F_1,\dots,F_d$.
\end{theorem}

\begin{corollary}[Copula of a multivariate distribution]
	\label{cor:cop1}
	Let $X=(X_1, \dots, X_d)$ a random vector with a multivariate 
	distribution $F$ and continuous marginals $F_1, \dots, F_n$. 
	Then its copula is:
	\begin{displaymath}
		C(u_1,\dots,u_n) = F(F_1^{-1}(u_1), \dots, F_n^{-1}(u_n))
	\end{displaymath}
\end{corollary}
%\begin{proof}
%This is a direct application of Sklar's theorem:
%\begin{displaymath}
%C(F_1(x_1), \dots, F_d(x_d)) = 
%F(F_1^{-1}(F_1(x_1)), \dots, F_d^{-1}(F_d(x_d))) = 
%F(x_1, \dots, x_d)
%\end{displaymath}
%\end{proof}

\begin{corollary}[Copula simulation]
	\label{cor:cop2}
	Let $X=(X_1, \dots, X_d)$ a random vector with a multivariate 
	distribution $F$ and continuous marginals $F_1, \dots, F_n$.
	If we have a procedure to simulate $X$ then we can simulate 
	its copula $C$ using:
	\begin{displaymath}
		(U_1, \dots, U_d) = (F_1(X_1), \dots, F_d(X_d))
	\end{displaymath}
\end{corollary}

\begin{corollary}[Multivariate distribution simulation]
	\label{cor:cop3}
	Let $X=(X_1, \dots, X_d)$ a random vector with a copula $C$
	and continuous marginals $F_1, \dots, F_n$. If we have a
	procedure to simulate $C$ then we can simulate $X$ using:
	\begin{displaymath}
		(X_1, \dots, X_d) = (F_1^{-1}(U_1), \dots, F_d^{-1}(U_d))
	\end{displaymath}
	where $U_i$ are the copula components.
\end{corollary}

%TODO: posar llibres de referencia
%TODO: eliptical copulas

%------------------------------------------------------------------------------
% MULTIVARIATE t-STUDENT DISTRIBUTION
%------------------------------------------------------------------------------
\section{Multivariate t-Student Distribution}
\label{ap:mtsd}

\begin{definition}[Multivariate t-Student distribution]
	The $d$-dimensional random vector $X=(X_1,\dots,X_d)$ is said to have a 
	(non-singular) multivariate t-Student distribution with $\nu$ degrees of freedom, 
	mean vector $\mu$ and positive-definite dispersion or scatter matrix $\Sigma$, 
	denoted $t \sim t_d(\nu,\mu,\Sigma)$, if its density is given by
	\begin{displaymath}
		f(x)=\frac{\Gamma\left(\frac{\nu+d}{2}\right)}{\Gamma\left(\frac{\nu}{2}\right)\sqrt{(\pi \nu)^d |\Sigma|}}
		\left(
		1+ \frac{(x-\mu)^\top\Sigma^{-1}(x-\mu)}{\nu}
		\right)^{-\frac{\nu+d}{2}}
	\end{displaymath}
	\noindent where $\Gamma$ is the gamma function, and $|\Sigma|$ is the 
	determinant of the matrix.
\end{definition}

\begin{proposition}[Gaussian as limit of the t-Student]
	The t-Student distribution converges to a Gaussian distribution 
	when $\nu$ tend to $\infty$.
	\begin{displaymath}
		\lim_{\nu \to \infty} t_d(\nu,\mu,\Sigma) = N(\mu,\Sigma)
	\end{displaymath}
\end{proposition}

\begin{proposition}[Multivariate t-Student characterization]
	\label{prop:mtschar}
	A random vector $T \sim t_d(\nu,\mu,\Sigma)$ can be expresed as:
	\begin{displaymath}
		T \stackrel{d}{=} \mu + \sqrt{\frac{\nu}{V}}\cdot Z
		\quad \text{ where } Z \sim N(0,\Sigma) \text{ and } V \sim \chi_{\nu}^2
	\end{displaymath}
\end{proposition}

\begin{proposition}[Multivariate t-Student marginals] \cite{kotz:2004}
	Let $X \sim t_d(\nu,\vec{0},\Sigma)$. Then, its i-th marginal is 
	$X_i \sim t_1(\nu,0,R_{ii})$.
\end{proposition}

\begin{definition}[t-Student copula]
	The t-Student copula, $C_{\nu,\Sigma}^d$, is the copula of the multivariate 
	t-Student distribution $t_d(\nu,\mu,\Sigma)$.
\end{definition}

\begin{proposition}[t-Student copula invariance]
	The copula of $t_d(\nu,\mu,\Sigma)$ is identical of that of $t_d(\nu,\vec{0},R)$
	where $R$ is the correlation matrix implied by the dispersion matrix $\Sigma$.
\end{proposition}

\begin{proposition}[t-Student copula density]
	The t-Student copula, $C_{\nu,R}^d$, where $R$ is a correlation matrix,
	has the following distribution:
	\begin{displaymath}
		C_{\nu,R}^d(u_1, \dots, u_d) = 
		\int_{-\infty}^{t_\nu^{-1}(u_1)} \dots \int_{-\infty}^{t_\nu^{-1}(u_d)} f(x) \ud x
	\end{displaymath}
	where $f(x)$ is the density function of $t_d(\nu,\vec{0},R)$, and $t_{\nu}^{-1}$ 
	denotes the quantile function of the univariate distribution $t_1(\nu,0,1)$. 
	The copula density is
	\begin{displaymath}
		\label{eq:density}
		c_{\nu,R}^d(u_1,\dots,u_d) =
		|R|^{-\frac{1}{2}} 
		\displaystyle\frac{\Gamma{\left(\frac{\nu+d}{2}\right)}}{\Gamma{\left(\frac{\nu}{2}\right)}}
		\displaystyle\left[ \frac{\Gamma{\left(\frac{\nu}{2}\right)}}{\Gamma{\left(\frac{\nu+1}{2}\right)}} \right]^d
		\frac{\displaystyle\left( 1+\frac{\zeta' R^{-1} \zeta}{\nu}\right)^{-\frac{\nu+d}{2}}}{\displaystyle\prod_{i=1}^d \left( 1+\frac{\zeta_i^2}{\nu} \right)^{-\frac{\nu+1}{2}}}
	\end{displaymath}
	\noindent
	where $\zeta=(t_\nu^{-1}(u_1), \dots, t_\nu^{-1}(u_n))$ is the vector of 
	the t-student univariate inverse distribution functions.
\end{proposition}

%------------------------------------------------------------------------------
% COVARIANCE BLOCK MATRIX
%------------------------------------------------------------------------------
\section{Covariance Block Matrix}
\label{ap:cbm}

\begin{definition}[Covariance Block Matrix]
	We say that a matrix $A$ is a covariance block matrix $B_k(n,d,M)$ where:
	\begin{itemize}
		\item $n=(n_1,\dots,n_k)$ with $n_i \in \mathbb{N}$ and $1 \le n_i$ (number of elements per block),
		\item $d=(d_1,\dots,d_k)$ with $d_i \in \mathbb{R}$ (diagonal block values), and
		\item $M$ is a $k {\times} k$ symmetric matrix with values $m_{ij} \in \mathbb{R}$ (block values).
	\end{itemize}
	when
	\begin{itemize}
		\item each block $B_{ij}$ is a $n_i {\times} n_j$ constant matrix with value $m_{ij}$
		\item diagonal blocks $B_{ii}$ have diagonal values $d_i$
		\item A is definite-positive
	\end{itemize}
\end{definition}

\begin{example}[Correlation Block Matrix]
	\label{example1}
	We have $6$ obligors sorted by sector. The first three belong to the 
	banking sector, the next two belong to the energy sector 
	and the last one belongs to the services sector. The correlations are 
	determined by sectors, where $m_{ij}$ is the correlation between two 
	obligors belonging to sectors $i$ and $j$. Then the correlation matrix 
	between obligors is:
	\begin{displaymath}
		R=
		\left(
		\begin{array}{ccc|cc|c} 
			1   & 0.5 & 0.5 & 0.2  & 0.2  & 0.1  \\ 
			0.5 & 1   & 0.5 & 0.2  & 0.2  & 0.1  \\ 
			0.5 & 0.5 & 1   & 0.2  & 0.2  & 0.1  \\ 
			\hline
			0.2 & 0.2 & 0.2 & 1    & 0.4  & 0.15 \\ 
			0.2 & 0.2 & 0.2 & 0.4  & 1    & 0.15 \\ 
			\hline
			0.1 & 0.1 & 0.1 & 0.15 & 0.15 & 1    
		\end{array} 
		\right)
	\end{displaymath}
\end{example}

\begin{proposition}[Covariance block matrix eigenvalues]
	\label{prop1}
	Let $A = B_k(n, d, M)$ a non-singular matrix, and let $G$ be the $k {\times} k$ 
	deflated matrix
	\begin{displaymath}
		G =
		\left( \begin{array}{cccc}
		d_1+(n_1-1)\cdot m_{11} & n_2 \cdot m_{12}        & \dots  & n_k \cdot m_{1k} \\
		n_1\cdot m_{21}         & d_2+(n_2-1)\cdot m_{22} & \dots  & n_k \cdot m_{2k} \\
		\vdots                  & \vdots                  & \ddots & \vdots \\
		n_1\cdot m_{k1}         & n_2 \cdot m_{k2}        & \dots  & d_k+(n_k-1)\cdot m_{kk} \\
		\end{array} \right)
	\end{displaymath}
	Then, the eigenvalues of $A$ are as follows:
	\begin{itemize}
		\item $d_{r}-m_{rr}$ with multiplicity $n_r-1$ for $r=1,\dots,k$.
		\item $\lambda_r$, the eigenvalues of $G$ with multiplicity $1$.
	\end{itemize}
\end{proposition}

\begin{corollary}
	A covariance block matrix $B_k(n,d,M)$ is definite-positive if
	\begin{itemize}
		\item $d_r > m_{rr}$ for all $r=1,\dots,k$, and
		\item the deflated matrix $G$ is definite-positive.
	\end{itemize}
\end{corollary}

%------------------------------------------------------------------------------
% MULTI-FACTOR GAUSSIAN MODEL
%------------------------------------------------------------------------------
\section{Multi-Factor Gaussian Model}
\label{ap:mfgm}

\begin{definition}[Gaussian multi-factor model]
\label{def:gmfm}
	We say that a multivariate distribution $X$ follows a Gaussian multi-factor
	model if it can be expressed in the form:
	\begin{displaymath}
		X_i^j = w_i \cdot Z_i + \sqrt{1-w_i^2} \cdot \epsilon_i^j
		\quad \text{ where } \left\{
		\begin{array}{l}
			i = 1, \dots, k \quad \text{ and $k$ is the number of blocks}    \\
			j = 1, \dots, n_i \quad \text{ and $n_i$ is i-th block size}     \\
			Z \sim N(0,R), \text{ and $R$ a $k {\times} k$ correlation matrix} \\
			w_i \in (0,1), \text{ are the factor loadings }                  \\
			\epsilon_i^j \sim N(0,1) \text { iid } \forall i,j               \\
			Z, \epsilon_i^j \text{ independents } \forall i,j                \\
		\end{array}
		\right.
	\end{displaymath}
An alternative definition based on the covariance matrix is:
	\begin{displaymath}
		X_i^j = Z_i + \sqrt{1-m_{ii}^2} \cdot \epsilon_i^j
		\quad \text{ where } \left\{
		\begin{array}{l}
			i = 1, \dots, k \quad \text{ and $k$ is the number of blocks}    \\
			j = 1, \dots, n_i \quad \text{ and $n_i$ is i-th block size}     \\
			Z \sim N(0,M), \text{ and $M$ a $k {\times} k$ covariance matrix} \\
			m_{ii} \in (0,1), \quad \text{diagonal values of $M$}            \\
			\epsilon_i^j \sim N(0,1) \text { iid } \forall i,j               \\
			Z, \epsilon_i^j \text{ independents } \forall i,j                \\
		\end{array}
		\right.
	\end{displaymath}
\end{definition}

\begin{proposition}[The Gaussian multi-factor model is a Gaussian distribution]
	\label{prop:gmfigs}
	The Gaussian multi-factor model defined by factor loadings 
	$w_1,\dots,w_k$, the $k {\times} k$ factors correlation matrix $R$, and
	$n_1,\dots,n_k$ with $\sum_{i=1}^k n_i = n$ is a multivariate Gaussian 
	distribution with a $n {\times} n$ block correlation matrix 
	$\bar{R}=B_k(\vec{n},\vec{1},M)$ with values
	$M_{ij} = w_i \cdot w_j \cdot R_{ij}$.
\end{proposition}
\begin{proof}
	We check that the correlations between Gaussian multi-factor model
	components is a matrix composed by blocks that fulfill the equivalence.
	\begin{displaymath}
		\begin{array}{rl}
			\text{Var}(X_i^j) =                       &                                                                                                            
			w_i \cdot \text{Var}(Z_i) + (1-w_i^2) \cdot \text{Var}(\epsilon_i^j) +
			2 \cdot w_i \cdot \sqrt{1-w_i^2} \cdot \text{Cov}(Z_i, \epsilon_i^j) \\
			=                                         & w_i + (1-w_i^2) = 1                                                                                        \\
			                                          &                                                                                                            \\
			\text{Cor}(X_{i_1}^{j_1},X_{i_2}^{j_2}) = & \text{Cov}(X_{i_1}^{j_1},X_{i_2}^{j_2})                                                                    \\
			=                                         & w_{i_1} \cdot w_{i_2} \cdot \text{Cov}(Z_{i_1},Z_{i_2}) +                                                  \\
			                                          & + w_{i_1} \cdot \sqrt{1-w_{i_2}^2} \cdot \text{Cov}(Z_{i_1}, \epsilon_{i_2}^{j_2}) +                       \\
			                                          & + \sqrt{1-w_{i_1}^2} \cdot w_{i_2} \cdot \text{Cov}(Z_{i_2}, \epsilon_{i_1}^{j_1}) +                       \\
			                                          & + \sqrt{1-w_{i_1}^2} \cdot \sqrt{1-w_{i_2}^2} \cdot \text{Cov}(\epsilon_{i_1}^{j_1}, \epsilon_{i_2}^{j_2}) \\
			=                                         & w_{i_1} \cdot w_{i_2} \cdot \text{Cov}(Z_{i_1}, Z_{i_2})                                                   \\
			=                                         & w_{i_1} \cdot w_{i_2} \cdot R_{i_1,i_2}                                                                    \\
		\end{array}
	\end{displaymath}
	The caracterization of the multivariate Gaussian \cite[thm 2.6.2]{anderson:1984}
	states that if every linear combination of the components of a 
	vector $X$ is normally distributed, then $X$ is normally distributed.
	It is straightforward to check that the multi-factor Gaussian model 
	fulfills this property and consequently it is a multivariate Normal.
\end{proof}

\begin{proposition}[Gaussian multi-factor model $\subsetneq$ multivariate Gaussian block]
	Any multi-factor model can be expressed as a multivariate Gaussian 
	block, but there are multivariate Gaussian block that can not be 
	expressed as a Gaussian multi-factor model.
\end{proposition}
\begin{proof}
	Proposition \ref{prop:gmfigs} states that any multi-factor model 
	can be expressed as a multivariate normal composed by blocks.
	Next we see that reciprocal is false. Let 
	$\bar{R} = B_k(\vec{n},\vec{1},M)$ the Gaussian distribution 
	correlation matrix. We use the equivalence 
	$M_{ij} = w_i \cdot w_i \cdot R_{ij}$ stated in proposition 
	\ref{prop:gmfigs} to determine the cases that cannot be expressed 
	as a multi-factor model.

	\textbf{Case 1}. Factor loadings with imaginary values.
	\begin{displaymath}
		M_{ii} = w_i \cdot w_i \cdot R_{ii} = w_i^2
	\end{displaymath}
	If $M_{ii}$ is negative, then $w_i$ has an imaginary value.
	By example:
	\begin{displaymath}
		\bar{R} = \left(
		\begin{array}{cc|c}
			1    & -0.5 & 0 \\
			-0.5 & 1    & 0 \\
			\hline
			0    & 0    & 1 \\
		\end{array}
		\right) 
		\longrightarrow
		R = \left(
		\begin{array}{cc}
			1 & 0 \\
			0 & 1 \\
		\end{array}
		\right)
		\text{ , }
		w = (\sqrt{-0.5}, 1)
		\text{ !!}
	\end{displaymath}
	
	\textbf{Case 2}. Factors correlation with absolute value > 1.
	\begin{displaymath}
		M_{ij} = w_i \cdot w_j \cdot R_{ij} \longrightarrow 
		R_{ij} = \frac{M_{ij}}{w_i \cdot w_j} = 
		\frac{M_{ij}}{\sqrt{M_{ii} \cdot M_{jj}}}
	\end{displaymath}
	If $M_{ii}^2 > M_{ii} \cdot M_{jj}$, then $R_{ij}$ has an absolute value
	bigger than 1, which is not possible because $R_{ij}$ is a correlation
	value. By example:
	\begin{displaymath}
		\bar{R} = \left(
		\begin{array}{cc|cc}
			1   & 0.5 & 0.6 & 0.6 \\
			0.5 & 1   & 0.6 & 0.6 \\
			\hline
			0.6 & 0.6 & 1   & 0.5 \\
			0.6 & 0.6 & 0.5 & 1   \\
		\end{array}
		\right) 
		\longrightarrow
		R = \left(
		\begin{array}{cc}
			1               & \frac{0.6}{0.5} \\
			\frac{0.6}{0.5} & 1               \\
		\end{array}
		\right)
		\text{ , }
		w = (\sqrt{0.5}, \sqrt{0.5})
		\text{ !!}
	\end{displaymath}
\end{proof}

It's disturbing that exist multivariate block Gaussian distributions 
that can't be expressed as a multi-factor model. Fortunately the 
cases where that ocurre haven't practical interest in credit risk
modeling where the number of obligors in each block are higher. 
The following proposition clarifies this theme.

\begin{proposition}[Gaussian multi-factor model $\approx$ multivariate Gaussian block]
	\label{prop:gmfamgb}
	Let $X \sim N(0,\bar{R})$ with $\bar{R}$ a correlation block matrix 
	$B_k(\vec{n},\vec{1},M)$. Then $X$ can be expressed as a multi-factor 
	Gaussian model if $n_i$ values are large enough.
\end{proposition}
\begin{proof}
	We revise the cases where the multivariate Gaussian distribution can't
	be expressed as a multi-factor model and we use the proposition 
	\ref{prop1} to check that if $n_i$ values are large enough, then 
	that is indeed a valid multi-factor model.
	
	\textbf{Case 1}. Factor loading $w_i$ with imaginary value is caused by 
	a negative $m_{ii}$ value ($m_{ii} = w_i^2$). We use the proposition 
	\ref{prop1} to determine the restrictions about $m_{ii}$. Because 
	$\bar{R}$ is covariance block matrix definite-positive, the deflated 
	matrix has a positive determinant. Then,
	\begin{displaymath}
		\begin{array}{l}
			1 + (n_1-1) \cdot m_{11} + (n_2-1) \cdot m_{22} +                     
			(n_1-1) \cdot (n_2-1) \cdot m_{11} \cdot m_{22} -                     
			n_1 \cdot n_2 \cdot m_{12}^2 > 0                                      
			                                                                      \\
			m_{11} > \frac{n_1 \cdot n_2 \cdot m_{12}^2 -1 -(n_2-1) \cdot m_{22}} 
			{(n_1-1) + (n_1-1) \cdot (n_2-1) \cdot m_{22}}                        
			                                                                      \\
			\text{tending } n_1 \to \infty \text{ and } n_2 \to \infty
			                                                                      \\
			m_{11} \ge 0                                                          
		\end{array}
	\end{displaymath}
	
	\textbf{Case 2}. Multi-factor model correlation bigger than $1$ is caused
	by $m_{12} = w_1 \cdot w_2 \cdot R_{12} = \sqrt{m_{11}} \cdot \sqrt{m_{22}} \cdot R_{12}$
	causing $R_{12} = \frac{m_{12}}{\sqrt{m_{11} \cdot m_{22}}}$.
	We use the proposition \ref{prop1} to determine the restrictions about $m_{ij}$. 
	Because $\bar{R}$ is covariance block matrix definite-positive, the deflated 
	matrix has a positive determinant. Then,
	\begin{displaymath}
		\begin{array}{l}
			1 + (n_1-1) \cdot m_{11} + (n_2-1) \cdot m_{22} +                     
			(n_1-1) \cdot (n_2-1) \cdot m_{11} \cdot m_{22} -                     
			n_1 \cdot n_2 \cdot m_{12}^2 > 0                                      
			                                                                      \\
			m_{12}^2 <                                                            
			\frac{1}{n_1 \cdot n_2} +                                             
			\frac{(n_1-1)}{n_1 \cdot n_2} \cdot m_{11} +                          
			\frac{(n_2-1)}{n_1 \cdot n_2} \cdot m_{22} +                          
			\frac{(n_1-1) \cdot (n_2-1)}{n_1 \cdot n_2} \cdot m_{11} \cdot m_{22} 
			                                                                      \\
			\text{tending } n_1 \to \infty \text{ and } n_2 \to \infty            
			                                                                      \\
			m_{12}^2 \le m_{11} \cdot m_{22}                                      
		\end{array}
	\end{displaymath}
\end{proof}


%----------------------------------------------------------------------------------------
%	BIBLIOGRAPHY
%----------------------------------------------------------------------------------------
\chapter*{Bibliography}
\addcontentsline{toc}{chapter}{\textcolor{ocre}{Bibliography}}
% \section*{Books}
% \addcontentsline{toc}{section}{Books}
% \printbibliography[heading=bibempty,type=book]
% \section*{Articles}
% \addcontentsline{toc}{section}{Articles}
% \printbibliography[heading=bibempty,type=article]
% \section*{Others}
% \addcontentsline{toc}{section}{Others}
% \printbibliography[heading=bibempty,type=techreport]

\section*{References}
%\addcontentsline{toc}{section}{References}
\printbibliography[heading=bibempty]

%----------------------------------------------------------------------------------------
%	INDEX
%----------------------------------------------------------------------------------------
\cleardoublepage
\setlength{\columnsep}{0.75cm}
\addcontentsline{toc}{chapter}{\textcolor{ocre}{Index}}
\printindex

%----------------------------------------------------------------------------------------

\end{document}
